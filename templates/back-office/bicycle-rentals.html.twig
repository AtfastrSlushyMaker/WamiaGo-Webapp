{% extends 'back-office/base.html.twig' %}

{% block title %}Bicycle Management Dashboard{% endblock %}

{% block content %}
{% set active_tab = app.request.get('tab', 'rentals') %}

<div class="container-fluid">
    <!-- Dashboard Header with Stats Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">Bicycle Management Dashboard</h1>
                    <p class="text-muted">Manage your bicycle rentals, stations and fleet</p>
                </div>
                <div class="d-flex">
                    <div class="dropdown me-2">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                            {% if active_tab == 'rentals' %}
                                <li><a class="dropdown-item" href="{{ path('admin_bicycle_rental_export') }}{% if app.request.query.all|length > 0 %}?{{ app.request.query.all|url_encode }}{% endif %}"><i class="fas fa-file-csv me-2"></i>Export to CSV</a></li>
                                <li><a class="dropdown-item" href="#" id="export-excel"><i class="fas fa-file-excel me-2"></i>Export to Excel</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-file-pdf me-2"></i>Export to PDF</a></li>
                            {% else %}
                                <li><a class="dropdown-item" href="#"><i class="fas fa-file-csv me-2"></i>Export to CSV</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-file-excel me-2"></i>Export to Excel</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-file-pdf me-2"></i>Export to PDF</a></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Navigation Tabs - Enhanced Design -->
    <div class="card mb-4">
        <div class="card-body p-0">
            <ul class="nav nav-tabs-custom" id="bicycleManagementTabs" role="tablist">
                <li class="nav-item flex-fill text-center">
                    <a class="nav-link d-flex flex-column align-items-center py-3 {{ active_tab == 'rentals' ? 'active' : '' }} tab-link" 
                       href="#" 
                       data-tab="rentals"
                       data-bs-toggle="tab"
                       data-bs-target="#rentalsTab">
                        <i class="fas fa-receipt mb-1 tab-icon"></i>
                        <span>Rentals</span>
                    </a>
                </li>
                <li class="nav-item flex-fill text-center">
                    <a class="nav-link d-flex flex-column align-items-center py-3 {{ active_tab == 'bicycles' ? 'active' : '' }} tab-link" 
                       href="#" 
                       data-tab="bicycles"
                       data-bs-toggle="tab"
                       data-bs-target="#bicyclesTab">
                        <i class="fas fa-bicycle mb-1 tab-icon"></i>
                        <span>Bicycles</span>
                    </a>
                </li>
                <li class="nav-item flex-fill text-center">
                    <a class="nav-link d-flex flex-column align-items-center py-3 {{ active_tab == 'stations' ? 'active' : '' }} tab-link"
                       href="#" 
                       data-tab="stations"
                       data-bs-toggle="tab"
                       data-bs-target="#stationsTab">
                        <i class="fas fa-map-marker-alt mb-1 tab-icon"></i>
                        <span>Stations</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content with Animation -->
    <div class="tab-content fade-in" id="bicycleManagementTabsContent">
        <div class="tab-pane fade {{ active_tab == 'rentals' ? 'show active' : '' }}" id="rentalsTab" role="tabpanel">
            {% include 'back-office/bicycle/rental.html.twig' with {
                'rentals': rentals|default([]),
                'stations': stations|default([]),
                'stats': stats|default({})
            } %}
        </div>
        <div class="tab-pane fade {{ active_tab == 'bicycles' ? 'show active' : '' }}" id="bicyclesTab" role="tabpanel">
            {% include 'back-office/bicycle/bicycle.html.twig' with {
                'bicycles': bicycles|default([]),
                'stations': stations|default([]),
                'addBicycleForm': addBicycleForm is defined ? addBicycleForm : false,
                'editBicycleForm': editBicycleForm is defined ? editBicycleForm : false,
                'stationAssignForm': stationAssignForm is defined ? stationAssignForm : false,
                'maintenanceForm': maintenanceForm is defined ? maintenanceForm : false,
                'availableCount': availableCount is defined ? availableCount : 0,
                'inUseCount': inUseCount is defined ? inUseCount : 0,
                'maintenanceCount': maintenanceCount is defined ? maintenanceCount : 0,
                'chargingCount': chargingCount is defined ? chargingCount : 0
            } %}
        </div>
        <div class="tab-pane fade {{ active_tab == 'stations' ? 'show active' : '' }}" id="stationsTab" role="tabpanel">
            {% include 'back-office/bicycle/station.html.twig' with {
                'stations': stations|default([]),
                'stationForm': stationForm is defined ? stationForm : false,
                'stationCounts': stationCounts|default([]),
                'totalCapacity': totalCapacity|default(0),
                'totalChargingDocks': totalChargingDocks|default(0),
                'stationActivity': stationActivity|default([])
            } %}
        </div>
    </div>
</div>
{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    /* Enhanced Tab Styling */
    .nav-tabs-custom {
        border-bottom: none;
        display: flex;
        width: 100%;
    }
    
    .nav-tabs-custom .nav-item {
        margin-bottom: 0;
        border-right: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .nav-tabs-custom .nav-item:last-child {
        border-right: none;
    }
    
    .nav-tabs-custom .nav-link {
        border: none;
        border-radius: 0;
        color: #6c757d;
        font-weight: 500;
        padding: 1rem 1.5rem;
        transition: all 0.25s ease;
        position: relative;
    }
    
    .nav-tabs-custom .nav-link .tab-icon {
        font-size: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .nav-tabs-custom .nav-link:hover {
        color: #212529;
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    .nav-tabs-custom .nav-link:hover .tab-icon {
        transform: translateY(-3px);
    }
    
    .nav-tabs-custom .nav-link.active {
        color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    .nav-tabs-custom .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background-color: #0d6efd;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from { transform: scaleX(0); }
        to { transform: scaleX(1); }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching without page reload
    const tabLinks = document.querySelectorAll('.tab-link');
    
    tabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Get the tab name
            const tabName = this.dataset.tab;
            
            // Update URL without reloading the page (for bookmark-ability)
            const url = new URL(window.location);
            url.searchParams.set('tab', tabName);
            window.history.pushState({}, '', url);
            
            // The Bootstrap tab toggling is handled by data-bs-toggle and data-bs-target
        });
    });
    
    // Handle browser back/forward navigation
    window.addEventListener('popstate', function() {
        const url = new URL(window.location);
        const tabName = url.searchParams.get('tab') || 'rentals';
        
        // Find and activate the correct tab
        const tabToActivate = document.querySelector(`.tab-link[data-tab="${tabName}"]`);
        if (tabToActivate) {
            const tab = new bootstrap.Tab(tabToActivate);
            tab.show();
        }
    });
});
</script>
{% endblock %}