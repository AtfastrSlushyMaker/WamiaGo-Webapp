{% extends 'back-office/base.html.twig' %}

{% block title %}Bicycle Details - WamiaGo Admin{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/apexcharts@3.41.0/dist/apexcharts.css" rel="stylesheet">
<style>
    :root {
        --primary-color: #3a7bd5;
        --secondary-color: #00d2ff;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --light-bg: #f8f9fa;
        --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        --transition: all 0.3s ease;
    }

    /* Layout */
    .app-main {
        padding: 0;
    }

    .bicycle-details-container {
        padding: 0;
        max-width: 100%;
        margin: 0;
    }

    .content-wrapper {
        padding: 0 1.5rem 1.5rem;
    }

    /* Hero section */
    .hero-section {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        padding: 2rem 1.5rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .hero-section::before,
    .hero-section::after {
        content: '';
        position: absolute;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.1);
    }

    .hero-section::before {
        width: 300px;
        height: 300px;
        bottom: -150px;
        right: -50px;
    }

    .hero-section::after {
        width: 200px;
        height: 200px;
        top: -100px;
        left: 40%;
    }

    .bicycle-id-badge {
        background-color: white;
        color: #28a745;
        border-radius: 30px;
        padding: 0.5rem 1.25rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .bicycle-status {
        position: relative;
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1.25rem;
        border-radius: 30px;
        background: rgba(255, 255, 255, 0.2);
        margin-left: 1rem;
        font-weight: 600;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }

    .bicycle-visual {
        width: 140px;
        height: 140px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
    }

    .bicycle-img {
        font-size: 4.5rem;
        color: white;
    }

    /* Stats cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .stat-card {
        border-radius: 0.5rem;
        border: none;
        overflow: hidden;
        height: 100%;
    }

    .stat-icon {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
    }

    /* Battery visualization */
    .battery-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .battery-chart {
        width: 100px;
        height: 50px;
        position: relative;
    }

    .battery-body {
        width: 100%;
        height: 100%;
        border-radius: 8px;
        border: 2px solid #555;
        position: relative;
        overflow: hidden;
    }

    .battery-terminal {
        width: 8px;
        height: 20px;
        background: #555;
        position: absolute;
        top: 50%;
        right: -8px;
        transform: translateY(-50%);
        border-radius: 0 4px 4px 0;
    }

    .battery-level {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        transition: height 1s ease;
    }

    .battery-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
        font-size: 1rem;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    /* Map container */
    .map-container {
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--card-shadow);
        margin-bottom: 1.5rem;
    }

    .map-info {
        padding: 1rem;
        background: white;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
    }

    /* Leaflet customizations */
    .leaflet-popup-content-wrapper {
        border-radius: 8px;
        padding: 0;
        overflow: hidden;
    }

    .leaflet-popup-content {
        margin: 0;
        padding: 0;
    }

    .map-popup {
        padding: 0;
        overflow: hidden;
        width: 250px;
    }

    .map-popup-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 10px 15px;
        font-weight: bold;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .map-popup-body {
        padding: 10px 15px;
    }

    /* Timeline */
    .timeline {
        position: relative;
        padding-left: 2rem;
        margin-bottom: 1rem;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
        padding-left: 1.5rem;
        border-left: 2px dashed rgba(0, 0, 0, 0.1);
    }

    .timeline-item:last-child {
        border-left: none;
        padding-bottom: 0;
    }

    .timeline-item::before {
        content: "";
        position: absolute;
        left: -10px;
        top: 0;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background-color: var(--primary-color);
        border: 3px solid white;
        box-shadow: 0 0 0 3px rgba(58, 123, 213, 0.2);
    }

    .timeline-content {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: var(--card-shadow);
        margin-bottom: 1rem;
    }

    .timeline-date {
        color: #6c757d;
        font-size: 0.875rem;
    }

    /* Tab navigation */
    .bicycle-tabs {
        position: relative;
        margin-bottom: 2rem;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .nav-tabs {
        border: none;
    }

    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        padding: 1rem 1.5rem;
        position: relative;
        transition: var(--transition);
    }

    .nav-tabs .nav-link:hover {
        color: var(--primary-color);
        background: transparent;
    }

    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        background: transparent;
        border: none;
    }

    .nav-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--primary-color);
        border-top-left-radius: 3px;
        border-top-right-radius: 3px;
    }

    .nav-tabs .nav-link .badge {
        margin-left: 0.5rem;
        font-size: 0.7rem;
        padding: 0.35em 0.65em;
    }

    /* Cards styling */
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        height: 100%;
    }

    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        background: white;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1.25rem;
        border-top-left-radius: 12px !important;
        border-top-right-radius: 12px !important;
        font-weight: 600;
    }

    .card-body {
        padding: 1.25rem;
    }

    /* Floating Action Button */
    .fab {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        cursor: pointer;
        transition: var(--transition);
    }

    .fab:hover {
        transform: scale(1.1);
        background: var(--secondary-color);
    }

    .fab i {
        font-size: 1.5rem;
    }

    .fab-menu {
        position: fixed;
        bottom: 6rem;
        right: 2rem;
        display: none;
        flex-direction: column;
        align-items: flex-end;
        z-index: 999;
    }

    .fab-menu.active {
        display: flex;
    }

    .fab-item {
        display: flex;
        align-items: center;
        background: white;
        border-radius: 30px;
        padding: 0.5rem 1.25rem;
        margin-bottom: 0.75rem;
        box-shadow: var(--card-shadow);
        cursor: pointer;
        transition: var(--transition);
    }

    .fab-item:hover {
        transform: translateX(-5px);
    }

    .fab-item i {
        margin-right: 0.75rem;
        width: 20px;
        text-align: center;
    }

    /* Utility classes */
    .bg-status-available {
        background-color: rgba(46, 204, 113, 0.15);
        color: #2ecc71;
    }

    .bg-status-in-use {
        background-color: rgba(58, 123, 213, 0.15);
        color: #3a7bd5;
    }

    .bg-status-maintenance {
        background-color: rgba(243, 156, 18, 0.15);
        color: #f39c12;
    }

    .bg-status-reserved {
        background-color: rgba(52, 152, 219, 0.15);
        color: #3498db;
    }

    /* Responsive adjustments */
    @media (max-width: 991.98px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 767.98px) {
        .hero-section {
            text-align: center;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .bicycle-tabs .nav-link {
            padding: 0.75rem 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="bicycle-details-container">
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <!-- Bicycle ID and Status -->
                    <div class="d-flex flex-wrap align-items-center mb-3">
                        <div class="bicycle-id-badge">
                            <i class="fas fa-hashtag me-1"></i> BIKE-{{ '%04d'|format(bicycle.idBike) }}
                        </div>
                        <div class="bicycle-status">
                            {% if bicycle.status.value == 'available' %}
                                <div class="status-dot bg-success"></div>
                                <span>Available</span>
                            {% elseif bicycle.status.value == 'in_use' %}
                                <div class="status-dot bg-primary"></div>
                                <span>In Use</span>
                            {% elseif bicycle.status.value == 'maintenance' %}
                                <div class="status-dot bg-warning"></div>
                                <span>Maintenance</span>
                            {% elseif bicycle.status.value == 'reserved' %}
                                <div class="status-dot bg-info"></div>
                                <span>Reserved</span>
                            {% else %}
                                <div class="status-dot bg-secondary"></div>
                                <span>{{ bicycle.status.value|capitalize }}</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Bicycle Title and Last Updated -->
                    <h1 class="display-5 fw-bold mb-2">E-Bicycle Information</h1>
                    <p class="lead opacity-75 mb-4">Last updated: {{ bicycle.lastUpdated|date('M d, Y H:i') }}</p>
                    
                    <!-- Quick Stats -->
                    <div class="row g-3">
                        <div class="col-6 col-md-3">
                            <div class="hero-stat">
                                <div class="stat-value">{{ bicycle.batteryLevel }}%</div>
                                <div class="stat-label opacity-75">Battery</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="hero-stat">
                                <div class="stat-value">{{ bicycle.rangeKm }} km</div>
                                <div class="stat-label opacity-75">Range</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="hero-stat">
                                <div class="stat-value">{{ statistics.totalRentals }}</div>
                                <div class="stat-label opacity-75">Total Rentals</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="hero-stat">
                                <div class="stat-value">{{ statistics.totalDistance|number_format(1) }} km</div>
                                <div class="stat-label opacity-75">Total Distance</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mt-4 mt-lg-0 text-center">
                    <div class="bicycle-visual">
                        <i class="fas fa-bicycle bicycle-img"></i>
                    </div>
                    <div class="mt-3">
                        {% if bicycle.bicycleStation %}
                            <span class="badge bg-light text-dark px-3 py-2">
                                <i class="fas fa-map-marker-alt me-1 text-primary"></i> 
                                {{ bicycle.bicycleStation.name }}
                            </span>
                        {% else %}
                            <span class="badge bg-light text-dark px-3 py-2">
                                <i class="fas fa-question-circle me-1 text-warning"></i>
                                No Station Assigned
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="content-wrapper">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs bicycle-tabs" id="bicycleTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
                    <i class="fas fa-tachometer-alt me-2"></i>Overview
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="location-tab" data-bs-toggle="tab" data-bs-target="#location" type="button" role="tab" aria-controls="location" aria-selected="false">
                    <i class="fas fa-map-marked-alt me-2"></i>Location
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">
                    <i class="fas fa-history me-2"></i>History
                    <span class="badge bg-primary rounded-pill">{{ rentalHistory|length }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance" type="button" role="tab" aria-controls="maintenance" aria-selected="false">
                    <i class="fas fa-tools me-2"></i>Maintenance
                    <span class="badge bg-warning rounded-pill">{{ maintenanceHistory|length }}</span>
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content pt-4" id="bicycleTabsContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="stat-icon bg-success-subtle text-success">
                                    <i class="fas fa-route"></i>
                                </div>
                                <div>
                                    <div class="text-uppercase text-muted small mb-1">Total Distance</div>
                                    <div class="h3 mb-0">{{ statistics.totalDistance|number_format(1) }} km</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="stat-icon bg-primary-subtle text-primary">
                                    <i class="fas fa-bicycle"></i>
                                </div>
                                <div>
                                    <div class="text-uppercase text-muted small mb-1">Total Rentals</div>
                                    <div class="h3 mb-0">{{ statistics.totalRentals }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="stat-icon bg-warning-subtle text-warning">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div>
                                    <div class="text-uppercase text-muted small mb-1">Rental Duration</div>
                                    <div class="h3 mb-0">{{ (statistics.totalRentalDuration / 3600)|number_format(1) }} hrs</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="stat-icon bg-info-subtle text-info">
                                    <i class="fas fa-money-bill"></i>
                                </div>
                                <div>
                                    <div class="text-uppercase text-muted small mb-1">Revenue</div>
                                    <div class="h3 mb-0">{{ statistics.totalRevenue|number_format(2) }} TND</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Bicycle Details -->
                    <div class="col-lg-8 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="m-0"><i class="fas fa-info-circle me-2 text-primary"></i>Bicycle Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-4">
                                    <!-- Battery & Range -->
                                    <div class="col-md-6">
                                        <div class="battery-container">
                                            <div class="battery-chart">
                                                <div class="battery-body">
                                                    <div class="battery-terminal"></div>
                                                    <div class="battery-level {{ bicycle.batteryLevel >= 70 ? 'bg-success' : (bicycle.batteryLevel >= 30 ? 'bg-warning' : 'bg-danger') }}" style="height: {{ bicycle.batteryLevel }}%"></div>
                                                    <div class="battery-text">{{ bicycle.batteryLevel }}%</div>
                                                </div>
                                            </div>
                                            <h6 class="mt-2 mb-0">Battery Level</h6>
                                        </div>
                                        
                                        <!-- Battery & Range Charts -->
                                        <div class="data-group">
                                            <div class="data-label d-flex justify-content-between mb-1">
                                                <span>Battery Status</span>
                                                <span>{{ bicycle.batteryLevel }}%</span>
                                            </div>
                                            <div class="progress mb-3">
                                                <div class="progress-bar {{ bicycle.batteryLevel >= 70 ? 'bg-success' : (bicycle.batteryLevel >= 30 ? 'bg-warning' : 'bg-danger') }}" style="width: {{ bicycle.batteryLevel }}%"></div>
                                            </div>
                                            
                                            <div class="data-label d-flex justify-content-between mb-1">
                                                <span>Range</span>
                                                <span>{{ bicycle.rangeKm }} km</span>
                                            </div>
                                            <div class="progress">
                                                {% set maxRange = 50 %}
                                                {% set rangePercentage = (bicycle.rangeKm / maxRange * 100)|number_format(0) %}
                                                <div class="progress-bar {{ bicycle.batteryLevel >= 70 ? 'bg-success' : (bicycle.batteryLevel >= 30 ? 'bg-warning' : 'bg-danger') }}" style="width: {{ rangePercentage }}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Usage Chart -->
                                    <div class="col-md-6">
                                        <div class="chart-container" id="usageChart"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- QR Code and Actions -->
                    <div class="col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="m-0"><i class="fas fa-qrcode me-2 text-primary"></i>QR Code</h5>
                            </div>
                            <div class="card-body d-flex flex-column align-items-center">
                                <div class="qr-code mb-4">
                                    <i class="fas fa-qrcode fa-4x text-muted"></i>
                                </div>
                                <div class="mb-3 fw-bold">Bicycle #{{ '%04d'|format(bicycle.idBike) }}</div>
                                <button class="btn btn-outline-primary">
                                    <i class="fas fa-print me-2"></i>Print QR
                                </button>
                                
                                <hr class="w-100 my-4">
                                
                                <div class="w-100">
                                    <h6 class="mb-3">Quick Actions</h6>
                                    <a href="#" class="btn btn-sm btn-primary d-block mb-2" id="editBicycleActionBtn" data-bicycle-id="{{ bicycle.idBike }}">
                                        <i class="fas fa-edit me-2"></i>Edit Details
                                    </a>
                                    <button class="btn btn-sm btn-outline-success d-block mb-2" data-bs-toggle="modal" data-bs-target="#stationAssignModal" data-bicycle-id="{{ bicycle.idBike }}">
                                        <i class="fas fa-exchange-alt me-2"></i>Change Station
                                    </button>
                                    <div class="dropdown w-100 mb-2">
                                        <button class="btn btn-sm btn-outline-secondary w-100 dropdown-toggle text-start" type="button" id="statusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-sync-alt me-2"></i>Change Status
                                        </button>
                                        <ul class="dropdown-menu w-100" aria-labelledby="statusDropdown">
                                            {% if bicycle.status.value != 'available' %}
                                            <li><a class="dropdown-item" href="{{ path('admin_bicycle_change_status', {'id': bicycle.idBike, 'status': 'available'}) }}">
                                                <i class="fas fa-check text-success me-2"></i>Mark Available
                                            </a></li>
                                            {% endif %}
                                            
                                            {% if bicycle.status.value != 'maintenance' %}
                                            <li><a class="dropdown-item" href="{{ path('admin_bicycle_change_status', {'id': bicycle.idBike, 'status': 'maintenance'}) }}">
                                                <i class="fas fa-tools text-warning me-2"></i>Send to Maintenance
                                            </a></li>
                                            {% endif %}
                                            
                                            {% if bicycle.status.value != 'charging' %}
                                            <li><a class="dropdown-item" href="{{ path('admin_bicycle_change_status', {'id': bicycle.idBike, 'status': 'charging'}) }}">
                                                <i class="fas fa-battery-half text-info me-2"></i>Send to Charging
                                            </a></li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Location Tab -->
            <div class="tab-pane fade" id="location" role="tabpanel" aria-labelledby="location-tab">
                <!-- Map -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="m-0"><i class="fas fa-map-marked-alt me-2 text-primary"></i>Current Location</h5>
                        {% if bicycle.bicycleStation %}
                            <span class="badge rounded-pill bg-status-available">At Station</span>
                        {% else %}
                            <span class="badge rounded-pill bg-status-maintenance">No Station</span>
                        {% endif %}
                    </div>
                    <div class="card-body p-0">
                        <div id="bicycleMap" class="map-container"></div>
                    </div>
                </div>
                
                <!-- Station Management -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="m-0"><i class="fas fa-exchange-alt me-2 text-primary"></i>Station Management</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Current Assignment</h6>
                                {% if bicycle.bicycleStation %}
                                <div class="alert alert-success d-flex align-items-center">
                                    <i class="fas fa-check-circle me-3 fa-lg"></i>
                                    <div>
                                        <strong>Assigned to Station</strong>
                                        <p class="mb-0">{{ bicycle.bicycleStation.name }}</p>
                                    </div>
                                </div>
                                {% else %}
                                <div class="alert alert-warning d-flex align-items-center">
                                    <i class="fas fa-exclamation-circle me-3 fa-lg"></i>
                                    <div>
                                        <strong>No Station Assigned</strong>
                                        <p class="mb-0">This bicycle is not linked to any station.</p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h6>Station Actions</h6>
                                <button class="btn btn-primary mb-2 w-100" data-bs-toggle="modal" data-bs-target="#stationAssignModal" data-bicycle-id="{{ bicycle.idBike }}">
                                    <i class="fas fa-exchange-alt me-2"></i>Reassign To Different Station
                                </button>
                                {% if bicycle.bicycleStation %}
                                <a href="{{ path('admin_bicycle_station_detail', {'id': bicycle.bicycleStation.idStation}) }}" class="btn btn-outline-secondary w-100">
                                    <i class="fas fa-info-circle me-2"></i>View Station Details
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- History Tab -->
            <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Rental History -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="m-0"><i class="fas fa-history me-2 text-primary"></i>Rental History</h5>
                                <span class="badge bg-primary rounded-pill">{{ rentalHistory|length }}</span>
                            </div>
                            <div class="card-body">
                                {% if rentalHistory|length > 0 %}
                                <div class="timeline">
                                    {% for rental in rentalHistory %}
                                    <div class="timeline-item">
                                        <div class="timeline-content">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span class="badge bg-status-in-use px-3 py-2">Rental #{{ rental.id }}</span>
                                                <span class="timeline-date">{{ rental.getStart_time()|date('M d, Y') }}</span>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-6">
                                                    <div class="data-label">Started</div>
                                                    <div class="data-value">{{ rental.getStart_time()|date('H:i') }}</div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="data-label">Ended</div>
                                                    <div class="data-value">
                                                        {{ rental.getEnd_time() ? rental.getEnd_time()|date('H:i') : 'Ongoing' }}
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="data-label">User</div>
                                                    <div class="data-value">
                                                        {% if rental.user %}
                                                            <i class="fas fa-user me-1"></i> {{ rental.user.firstName }} {{ rental.user.lastName }}
                                                        {% else %}
                                                            <span class="text-muted">Unknown</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="data-label">Distance</div>
                                                    <div class="data-value">
                                                        {% if rental.distance is defined %}
                                                            {{ rental.distance }} km
                                                        {% else %}
                                                            <span class="text-muted">N/A</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-history fa-3x text-muted mb-3"></i>
                                    <h5>No Rental History</h5>
                                    <p class="text-muted">This bicycle has not been rented yet.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <!-- Usage Statistics -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="m-0"><i class="fas fa-chart-bar me-2 text-primary"></i>Usage Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" id="rentalStatsChart"></div>
                                
                                <hr class="my-4">
                                
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="data-group">
                                            <div class="data-label">Avg. Rental Time</div>
                                            <div class="data-value">
                                                {% if statistics.totalRentals > 0 %}
                                                    {{ ((statistics.totalRentalDuration / statistics.totalRentals) / 60)|number_format(0) }} min
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="data-group">
                                            <div class="data-label">Avg. Distance</div>
                                            <div class="data-value">
                                                {% if statistics.totalRentals > 0 %}
                                                    {{ (statistics.totalDistance / statistics.totalRentals)|number_format(1) }} km
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Maintenance Tab -->
            <div class="tab-pane fade" id="maintenance" role="tabpanel" aria-labelledby="maintenance-tab">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Maintenance History -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="m-0"><i class="fas fa-tools me-2 text-primary"></i>Maintenance History</h5>
                                <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#scheduleMaintenance">
                                    <i class="fas fa-plus me-1"></i>Schedule
                                </button>
                            </div>
                            <div class="card-body">
                                {% if maintenanceHistory|length > 0 %}
                                <div class="timeline">
                                    {% for maintenance in maintenanceHistory %}
                                    <div class="timeline-item">
                                        <div class="timeline-content">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span class="badge bg-status-maintenance px-3 py-2">Maintenance</span>
                                                <span class="timeline-date">{{ maintenance.date|date('M d, Y') }}</span>
                                            </div>
                                            <h5 class="mb-2">{{ maintenance.title }}</h5>
                                            <p class="mb-1 text-muted">{{ maintenance.description|default('No description provided.') }}</p>
                                            {% if maintenance.cost is defined %}
                                            <div class="mt-2 d-flex justify-content-between">
                                                <span class="badge bg-light text-dark">Cost: {{ maintenance.cost|default('N/A') }}</span>
                                                <span class="badge bg-light text-dark">Tech: {{ maintenance.technician|default('N/A') }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                                    <h5>No Maintenance Records</h5>
                                    <p class="text-muted">This bicycle has no maintenance history.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <!-- Health Status -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="m-0"><i class="fas fa-heartbeat me-2 text-primary"></i>Bicycle Health</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" id="healthChart"></div>
                                
                                <hr class="my-4">
                                
                                <h6 class="mb-3">Component Status</h6>
                                <div class="data-group">
                                    <div class="data-label d-flex justify-content-between mb-1">
                                        <span>Battery</span>
                                        <span>{{ bicycle.batteryLevel }}%</span>
                                    </div>
                                    <div class="progress mb-3">
                                        <div class="progress-bar {{ bicycle.batteryLevel >= 70 ? 'bg-success' : (bicycle.batteryLevel >= 30 ? 'bg-warning' : 'bg-danger') }}" style="width: {{ bicycle.batteryLevel }}%"></div>
                                    </div>
                                    
                                    <div class="data-label d-flex justify-content-between mb-1">
                                        <span>Brakes</span>
                                        <span>85%</span>
                                    </div>
                                    <div class="progress mb-3">
                                        <div class="progress-bar bg-success" style="width: 85%"></div>
                                    </div>
                                    
                                    <div class="data-label d-flex justify-content-between mb-1">
                                        <span>Tires</span>
                                        <span>90%</span>
                                    </div>
                                    <div class="progress mb-3">
                                        <div class="progress-bar bg-success" style="width: 90%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<div class="fab" id="fab">
    <i class="fas fa-bolt"></i>
</div>
<div class="fab-menu" id="fabMenu">
    <div class="fab-item" id="editBicycleFab" data-bicycle-id="{{ bicycle.idBike }}">
        <i class="fas fa-edit text-primary"></i>
        <span>Edit Bicycle</span>
    </div>
    <div class="fab-item" data-bs-toggle="modal" data-bs-target="#stationAssignModal">
        <i class="fas fa-exchange-alt text-success"></i>
        <span>Change Station</span>
    </div>
    <div class="fab-item" data-bs-toggle="modal" data-bs-target="#scheduleMaintenance">
        <i class="fas fa-tools text-warning"></i>
        <span>Schedule Maintenance</span>
    </div>
    <div class="fab-item" onclick="history.back()">
        <i class="fas fa-arrow-left text-secondary"></i>
        <span>Go Back</span>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.41.0/dist/apexcharts.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Floating Action Button
    const fab = document.getElementById('fab');
    const fabMenu = document.getElementById('fabMenu');
    
    fab.addEventListener('click', function() {
        fabMenu.classList.toggle('active');
    });
    
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#fab') && !e.target.closest('#fabMenu')) {
            fabMenu.classList.remove('active');
        }
    });
    
    // Edit bicycle functionality
    const editButtons = document.querySelectorAll('[data-bicycle-id]');
    editButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const bicycleId = this.getAttribute('data-bicycle-id');
            openEditModal(bicycleId);
        });
    });
    
    function openEditModal(bicycleId) {
        // Find the edit modal element
        const editModal = document.getElementById('editBicycleModal');
        if (!editModal) {
            // If modal doesn't exist in this page, redirect to the main bicycle page with the edit modal
            window.location.href = '{{ path('admin_bicycle_rentals', {'tab': 'bicycles'}) }}' + '?edit=' + bicycleId;
            return;
        }
        
        // Show the edit modal using Bootstrap's modal API
        const modal = new bootstrap.Modal(editModal);
        
        // Fetch bicycle data and populate the form
        fetch(`/admin/bicycle/bicycle/${bicycleId}/data`)
            .then(response => response.json())
            .then(data => {
                // Set form hidden id field
                const idField = document.querySelector('.bicycle-id-field');
                if (idField) idField.value = bicycleId;

                // Set form fields with bicycle data
                const batteryField = document.querySelector('#editBicycleForm [name$="[battery_level]"]');
                if (batteryField) batteryField.value = data.batteryLevel;

                const rangeField = document.querySelector('#editBicycleForm [name$="[range_km]"]');
                if (rangeField) rangeField.value = data.rangeKm;

                const statusSelect = document.querySelector('#editBicycleForm [name$="[status]"]');
                if (statusSelect) {
                    Array.from(statusSelect.options).forEach(option => {
                        if (option.value === data.status) {
                            option.selected = true;
                        }
                    });
                }
                
                // Show the modal
                modal.show();
            })
            .catch(error => {
                console.error('Error loading bicycle data:', error);
                alert('Error loading bicycle data. Please try again.');
            });
    }

    // Initialize map if bicycle has a station assigned
    {% if bicycle.bicycleStation and bicycle.bicycleStation.location %}
        const mapElement = document.getElementById('bicycleMap');
        if (mapElement) {
            const map = L.map('bicycleMap').setView([
                {{ bicycle.bicycleStation.location.latitude }}, 
                {{ bicycle.bicycleStation.location.longitude }}
            ], 15);
            
            // Add tile layer with modern style
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap contributors, © CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Custom marker icon for current station
            const stationIcon = L.divIcon({
                className: 'custom-marker-icon',
                html: `<div style="background:rgba(58, 123, 213, 0.85); color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(0,0,0,0.2);"><i class="fas fa-bicycle" style="font-size:12px;"></i></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            
            // Add marker for current station
            L.marker([
                {{ bicycle.bicycleStation.location.latitude }}, 
                {{ bicycle.bicycleStation.location.longitude }}
            ], { icon: stationIcon }).addTo(map)
              .bindPopup(`<div class="map-popup">
                <div class="map-popup-header">{{ bicycle.bicycleStation.name }}</div>
                <div class="map-popup-body">
                    <p class="mb-1"><strong>Current Location</strong></p>
                    <p class="mb-0 small">{{ bicycle.bicycleStation.location.address|default('No address data') }}</p>
                </div>
              </div>`)
              .openPopup();
              
            // Add markers for other stations
            {% for station in stations %}
                {% if station.idStation != bicycle.bicycleStation.idStation and station.location %}
                    const otherStationIcon = L.divIcon({
                        className: 'custom-marker-icon',
                        html: `<div style="background:rgba(0,0,0,0.4); color:white; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-map-marker-alt" style="font-size:10px;"></i></div>`,
                        iconSize: [18, 18],
                        iconAnchor: [9, 9]
                    });
                
                    L.marker([
                        {{ station.location.latitude }},
                        {{ station.location.longitude }}
                    ], { icon: otherStationIcon }).addTo(map)
                      .bindPopup(`<div class="map-popup">
                        <div class="map-popup-header">{{ station.name }}</div>
                        <div class="map-popup-body">
                            <p class="mb-0">Station</p>
                        </div>
                      </div>`);
                {% endif %}
            {% endfor %}
        }
    {% else %}
        // No station assigned, show a placeholder
        const mapElement = document.getElementById('bicycleMap');
        if (mapElement) {
            mapElement.innerHTML = `
                <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-map-marker-alt fa-3x mb-3"></i>
                        <h5>No Location Data</h5>
                        <p class="mb-0">This bicycle is not currently assigned to any station.</p>
                    </div>
                </div>
            `;
        }
    {% endif %}
    
    // Initialize charts
    if (document.getElementById('usageChart')) {
        const usageOptions = {
            series: [{
                name: 'Usage Hours',
                data: [3.2, 4.5, 2.1, 5.3, 3.8, 4.2, 6.1]
            }],
            chart: {
                type: 'bar',
                height: 200,
                toolbar: {
                    show: false
                },
                fontFamily: 'inherit'
            },
            plotOptions: {
                bar: {
                    borderRadius: 4,
                    columnWidth: '60%',
                }
            },
            colors: ['#3a7bd5'],
            xaxis: {
                categories: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                labels: {
                    style: {
                        fontSize: '12px'
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Hours'
                },
                labels: {
                    style: {
                        fontSize: '12px'
                    }
                }
            },
            grid: {
                borderColor: '#e0e0e0',
            },
            title: {
                text: 'Weekly Usage',
                align: 'left',
                style: {
                    fontSize: '14px',
                    fontWeight: 600
                }
            }
        };
        
        const usageChart = new ApexCharts(document.getElementById('usageChart'), usageOptions);
        usageChart.render();
    }
    
    if (document.getElementById('rentalStatsChart')) {
        const rentalOptions = {
            series: [{{ statistics.totalRentals|default(0) }}, 25],
            chart: {
                type: 'donut',
                height: 250,
                toolbar: {
                    show: false
                },
                fontFamily: 'inherit'
            },
            labels: ['Completed', 'Potential'],
            colors: ['#3a7bd5', '#e0e0e0'],
            legend: {
                position: 'bottom'
            },
            dataLabels: {
                enabled: false
            },
            plotOptions: {
                pie: {
                    donut: {
                        size: '65%',
                        labels: {
                            show: true,
                            name: {
                                show: true
                            },
                            value: {
                                show: true,
                                fontSize: '22px',
                                fontWeight: 'bold'
                            },
                            total: {
                                show: true,
                                label: 'Total',
                                formatter: function (w) {
                                    return {{ statistics.totalRentals|default(0) }};
                                }
                            }
                        }
                    }
                }
            }
        };
        
        const rentalStatsChart = new ApexCharts(document.getElementById('rentalStatsChart'), rentalOptions);
        rentalStatsChart.render();
    }

    if (document.getElementById('healthChart')) {
        const healthOptions = {
            series: [{
                name: 'Health Score',
                data: [90, 85, 95, 80, 70]
            }],
            chart: {
                type: 'radar',
                height: 250,
                toolbar: {
                    show: false
                },
                fontFamily: 'inherit',
                dropShadow: {
                    enabled: true,
                    blur: 1,
                    left: 1,
                    top: 1
                }
            },
            xaxis: {
                categories: ['Battery', 'Brakes', 'Frame', 'Tires', 'Electronics'],
                labels: {
                    style: {
                        fontSize: '12px',
                        fontWeight: 500
                    }
                }
            },
            yaxis: {
                show: false,
                max: 100
            },
            fill: {
                opacity: 0.4
            },
            colors: ['#3a7bd5'],
            markers: {
                size: 4,
                colors: ['#fff'],
                strokeColors: '#3a7bd5',
                strokeWidth: 2
            }
        };
        
        const healthChart = new ApexCharts(document.getElementById('healthChart'), healthOptions);
        healthChart.render();
    }
});
</script>
{% endblock %}