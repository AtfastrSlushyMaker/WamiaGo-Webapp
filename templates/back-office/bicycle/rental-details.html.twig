{% extends 'back-office/base.html.twig' %}

{% block title %}Rental B{{ '%05d'|format(rental.idUserRental) }} | WamiaGo Admin{% endblock %}

{% block page_stylesheets %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
{# Set status variables once for use throughout template #}
{% set status = 'Reserved' %}
{% set statusColor = 'warning' %}
{% set statusStep = 1 %}
{% if rental.startTime and rental.endTime %}
    {% set status = 'Completed' %}
    {% set statusColor = 'success' %}
    {% set statusStep = 3 %}
{% elseif rental.startTime %}
    {% set status = 'Active' %}
    {% set statusColor = 'primary' %}
    {% set statusStep = 2 %}
{% endif %}

{% set isPremium = rental.bicycle and rental.bicycle.batteryLevel > 90 %}
{% set batteryLevel = rental.bicycle ? rental.bicycle.batteryLevel : 0 %}
{% set batteryColor = batteryLevel > 70 ? 'success' : (batteryLevel > 30 ? 'warning' : 'danger') %}

<!-- Main Header Banner -->
<div class="bicycle-fleet-banner mb-4">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-auto">
                <div class="banner-icon">
                    <i class="fas fa-receipt"></i>
                </div>
            </div>
            <div class="col">
                <h1 class="banner-title">Rental Details</h1>
                <p class="banner-subtitle mb-0">Management and tracking of bicycle rental B{{ '%05d'|format(rental.idUserRental) }}</p>
            </div>
          
        </div>
    </div>
</div>

<div class="container-fluid px-4 animate__animated animate__fadeIn animate__faster">
    <!-- Navigation Bar -->
    <div class="card custom-card mb-4">
        <div class="card-body p-0">
            <div class="rental-nav">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0 p-3">
                        <li class="breadcrumb-item"><a href="{{ path('admin_bicycle_rentals') }}" class="text-decoration-none"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ path('admin_bicycle_rentals', {tab:"rentals"}) }}" class="text-decoration-none"><i class="fas fa-list me-1"></i>Rentals</a></li>
                        <li class="breadcrumb-item active fw-semibold" aria-current="page">Rental B{{ '%05d'|format(rental.idUserRental) }}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
        <div>
            <h2 class="section-title">
                <span class="badge rounded-pill bg-{{ statusColor }} me-2">
                    <i class="fas fa-{{ status == 'Reserved' ? 'clock' : (status == 'Active' ? 'bicycle' : 'check-circle') }} me-1"></i>
                    {{ status }}
                </span>
                Rental B{{ '%05d'|format(rental.idUserRental) }}
            </h2>
        </div>
        <div class="d-flex flex-wrap gap-2">
            {% if status == 'Reserved' %}
                <button type="button" class="btn btn-success btn-lg animate__animated animate__pulse animate__infinite activate-rental-btn" data-rental-id="{{ rental.idUserRental }}">
                    <i class="fas fa-play-circle me-2"></i>Activate Rental
                </button>
            {% elseif status == 'Active' %}
                <button type="button" class="btn btn-outline-success btn-lg" data-bs-toggle="modal" data-bs-target="#completeRentalModal">
                    <i class="fas fa-flag-checkered me-2"></i>End Rental
                </button>
            {% endif %}
            {% if status != 'Completed' %}
                <button type="button" class="btn btn-outline-danger btn-lg cancel-rental-btn" data-rental-id="{{ rental.idUserRental }}">
                    <i class="fas fa-ban me-2"></i>Cancel
                </button>
            {% endif %}
            
            <div class="btn-group">
                <a href="{{ path('admin_bicycle_rental_edit', {'id': rental.idUserRental}) }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-pen me-2"></i>Edit
                </a>
                <button type="button" class="btn btn-primary btn-lg dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="visually-hidden">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                    <li><a class="dropdown-item" href="#" onclick="window.print();"><i class="fas fa-print me-2"></i>Print Details</a></li>
                    <li><a class="dropdown-item" href="#" id="exportPdf"><i class="fas fa-file-pdf me-2"></i>Export as PDF</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#shareRentalModal"><i class="fas fa-share-alt me-2"></i>Share</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item text-danger delete-rental-btn" href="#" data-rental-id="{{ rental.idUserRental }}">
                            <i class="fas fa-trash me-2"></i>Delete Rental
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Alerts Section -->
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }} alert-dismissible shadow-sm fade show animate__animated animate__fadeInDown" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-{{ label == 'success' ? 'check-circle' : (label == 'danger' ? 'exclamation-circle' : 'info-circle') }} me-2 fa-lg"></i>
                    <div>{{ message }}</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endfor %}

    <!-- Rental Progress Timeline -->
    <div class="card border-0 shadow-sm mb-4 overflow-hidden">
        <div class="card-body">
            <div class="rental-timeline">
                <div class="d-flex align-items-center position-relative">
                    <div class="timeline-progress" style="width: {{ statusStep * 50 - 25 }}%;"></div>
                    <div class="timeline-step {{ statusStep >= 1 ? 'active' : '' }}">
                        <div class="timeline-icon">
                            <i class="fas fa-bookmark"></i>
                        </div>
                        <div class="timeline-label">Reserved</div>
                        <div class="timeline-date">{{ rental.startTime |date('M d, Y') }}</div>
                    </div>
                    <div class="timeline-step {{ statusStep >= 2 ? 'active' : '' }}">
                        <div class="timeline-icon">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <div class="timeline-label">Activated</div>
                        <div class="timeline-date">{{ rental.startTime ? rental.startTime|date('M d, Y') : 'Pending' }}</div>
                    </div>
                    <div class="timeline-step {{ statusStep >= 3 ? 'active' : '' }}">
                        <div class="timeline-icon">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="timeline-label">Completed</div>
                        <div class="timeline-date">{{ rental.endTime ? rental.endTime|date('M d, Y') : 'Pending' }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4">
        <!-- Left column: Rental and Usage Information -->
        <div class="col-lg-8">
            <div class="row g-4">
                <!-- Quick Stats Cards -->
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100 bg-gradient">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="icon-box text-white {{ status == 'Active' ? 'bg-primary' : (status == 'Completed' ? 'bg-success' : 'bg-warning') }}">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <h5 class="ms-3 mb-0">Duration</h5>
                            </div>
                            
                            {% if status == 'Active' %}
                                {% set duration_seconds = date().timestamp - rental.startTime.timestamp %}
                                {% set hours = (duration_seconds / 3600)|round(0, 'floor') %}
                                {% set minutes = ((duration_seconds % 3600) / 60)|round(0, 'floor') %}
                                <div class="timer-display text-primary" id="activeTimer" data-start="{{ rental.startTime|date('c') }}">
                                    <div class="d-flex align-items-end">
                                        <span class="timer-value">{{ hours }}</span>
                                        <span class="timer-unit">hrs</span>
                                        <span class="timer-value ms-2">{{ minutes }}</span>
                                        <span class="timer-unit">min</span>
                                    </div>
                                    <small class="text-muted"><i class="fas fa-sync-alt fa-spin me-1"></i>Active rental</small>
                                </div>
                            {% elseif status == 'Completed' %}
                                {% set duration_seconds = rental.endTime.timestamp - rental.startTime.timestamp %}
                                {% set hours = (duration_seconds / 3600)|round(0, 'floor') %}
                                {% set minutes = ((duration_seconds % 3600) / 60)|round(0, 'floor') %}
                                <div class="timer-display text-success">
                                    <div class="d-flex align-items-end">
                                        <span class="timer-value">{{ hours }}</span>
                                        <span class="timer-unit">hrs</span>
                                        <span class="timer-value ms-2">{{ minutes }}</span>
                                        <span class="timer-unit">min</span>
                                    </div>
                                    <small class="text-muted"><i class="fas fa-check-circle me-1"></i>Total duration</small>
                                </div>
                            {% else %}
                                <div class="timer-display text-warning">
                                    <div class="d-flex align-items-end">
                                        <span class="timer-value">0</span>
                                        <span class="timer-unit">hrs</span>
                                        <span class="timer-value ms-2">0</span>
                                        <span class="timer-unit">min</span>
                                    </div>
                                    <small class="text-muted"><i class="fas fa-hourglass me-1"></i>Awaiting activation</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100 bg-gradient">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="icon-box text-white bg-success">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <h5 class="ms-3 mb-0">Cost</h5>
                            </div>
                            <div class="d-flex align-items-end">
                                <h1 class="display-4 fw-bold mb-0 text-success">{{ rental.cost|number_format(3) }}</h1>
                                <h5 class="ms-2 mb-1">TND</h5>
                            </div>
                            <small class="text-muted">
                                {% if status == 'Completed' %}
                                    <i class="fas fa-check-circle me-1"></i>Final amount
                                {% elseif status == 'Active' %}
                                    <i class="fas fa-sync-alt fa-spin me-1"></i>Running total
                                {% else %}
                                    <i class="fas fa-tag me-1"></i>Estimated deposit
                                {% endif %}
                            </small>
                            {% if isPremium %}
                                <span class="badge bg-warning text-dark position-absolute top-0 end-0 m-3">
                                    <i class="fas fa-crown me-1"></i>Premium Rate
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Main Rental Details -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white p-4 border-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Rental Information</h5>
                                <span class="badge bg-{{ statusColor }} rounded-pill px-3 py-2 fs-6">{{ status }}</span>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-icon">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="detail-content">
                                            <label>Customer</label>
                                            <div class="d-flex align-items-center mt-1">
                                                <div class="user-avatar">
                                                    {{ rental.user ? rental.user.name : 'NA' }}
                                                </div>
                                                <h6 class="mb-0 ms-2">{{ rental.user ? rental.user.name  : 'Unknown User' }}</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-icon">
                                            <i class="fas fa-calendar-alt"></i>
                                        </div>
                                        <div class="detail-content">
                                            <label>Transaction Date</label>
                                            <div class="d-flex flex-column mt-1">
                                                <h6 class="mb-0">{{ rental.startTime|date('M d, Y') }}</h6>
                                                <small class="text-muted">{{ rental.startTime|date('h:i A') }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-icon">
                                            <i class="fas fa-map-marker-alt"></i>
                                        </div>
                                        <div class="detail-content">
                                            <label>Pick-up Station</label>
                                            <div class="station-badge">
                                                <i class="fas fa-store me-1"></i>
                                                <h6 class="mb-0">{{ rental.startStation ? rental.startStation.name : 'Not specified' }}</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-icon">
                                            <i class="fas fa-flag-checkered"></i>
                                        </div>
                                        <div class="detail-content">
                                            <label>Return Station</label>
                                            {% if rental.endStation %}
                                                <div class="station-badge">
                                                    <i class="fas fa-store me-1"></i>
                                                    <h6 class="mb-0">{{ rental.endStation.name }}</h6>
                                                </div>
                                            {% else %}
                                                <span class="badge bg-light text-dark rounded-pill">
                                                    <i class="fas fa-hourglass me-1"></i>Not returned yet
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-12">
                                    <hr>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-icon">
                                            <i class="fas fa-play"></i>
                                        </div>
                                        <div class="detail-content">
                                            <label>Start Time</label>
                                            {% if rental.startTime %}
                                                <div class="d-flex flex-column mt-1">
                                                    <h6 class="mb-0">{{ rental.startTime|date('M d, Y') }}</h6>
                                                    <small class="text-muted">{{ rental.startTime|date('h:i A') }}</small>
                                                </div>
                                            {% else %}
                                                <span class="badge bg-light text-dark rounded-pill">
                                                    <i class="fas fa-hourglass me-1"></i>Pending activation
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="detail-item">
                                        <div class="detail-icon">
                                            <i class="fas fa-stop"></i>
                                        </div>
                                        <div class="detail-content">
                                            <label>End Time</label>
                                            {% if rental.endTime %}
                                                <div class="d-flex flex-column mt-1">
                                                    <h6 class="mb-0">{{ rental.endTime|date('M d, Y') }}</h6>
                                                    <small class="text-muted">{{ rental.endTime|date('h:i A') }}</small>
                                                </div>
                                            {% else %}
                                                <span class="badge bg-light text-dark rounded-pill">
                                                    {% if status == 'Active' %}
                                                        <i class="fas fa-spinner fa-spin me-1"></i>In progress
                                                    {% else %}
                                                        <i class="fas fa-hourglass me-1"></i>Not started
                                                    {% endif %}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                {% if status == 'Completed' %}
                                <div class="col-12">
                                    <hr>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="metric-box text-center p-3">
                                        <div class="metric-icon mb-2">
                                            <i class="fas fa-route"></i>
                                        </div>
                                        <div class="metric-value">{{ rental.distanceKm|default(0)|number_format(1) }}</div>
                                        <div class="metric-label">kilometers</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="metric-box text-center p-3">
                                        <div class="metric-icon mb-2">
                                            <i class="fas fa-battery-half"></i>
                                        </div>
                                        <div class="metric-value">{{ rental.batteryUsed|default(0)|number_format(1) }}%</div>
                                        <div class="metric-label">battery used</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="metric-box text-center p-3">
                                        <div class="metric-icon mb-2">
                                            <i class="fas fa-tachometer-alt"></i>
                                        </div>
                                        {% set avg_speed = rental.distanceKm|default(0) > 0 and duration_seconds > 0 ? 
                                                          (rental.distanceKm / (duration_seconds / 3600))|round(1) : 0 %}
                                        <div class="metric-value">{{ avg_speed }}</div>
                                        <div class="metric-label">km/h avg speed</div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Map for Completed Rentals -->
                {% if status == 'Completed' and rental.startStation and rental.endStation %}
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white p-4 border-0">
                            <h5 class="mb-0"><i class="fas fa-map-marked-alt me-2"></i>Route Information</h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="rentalRouteMap" class="rental-map"></div>
                        </div>
                        <div class="card-footer bg-white py-3 px-4 d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-map-marker-alt text-danger me-1"></i>
                                <span class="fw-medium">{{ rental.startStation.name }}</span>
                                <i class="fas fa-long-arrow-alt-right mx-2"></i>
                                <i class="fas fa-flag-checkered text-success me-1"></i>
                                <span class="fw-medium">{{ rental.endStation.name }}</span>
                            </div>
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-route me-1"></i>{{ rental.distanceKm|default(0)|number_format(1) }} km
                            </span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Right column: Bicycle Information and Actions -->
        <div class="col-lg-4">
            <!-- Bicycle Information Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white p-4 border-0">
                    <h5 class="mb-0"><i class="fas fa-bicycle me-2"></i>Bicycle Information</h5>
                </div>
                
                {% if rental.bicycle %}
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div class="bicycle-image-container mb-3">
                            {% if isPremium %}
                                <div class="premium-badge"><i class="fas fa-crown"></i></div>
                            {% endif %}
                            <div class="bicycle-image {{ isPremium ? 'premium' : 'standard' }}">
                                <i class="fas fa-bicycle"></i>
                            </div>
                        </div>
                        <h4 class="mb-0">{{ isPremium ? 'Premium' : 'Standard' }} E-Bike</h4>
                        <p class="text-muted mb-0">ID: B{{ '%04d'|format(rental.bicycle.idBike) }}</p>
                    </div>
                    
                    <div class="specs-grid">
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-battery-three-quarters {{ batteryColor == 'success' ? 'text-success' : (batteryColor == 'warning' ? 'text-warning' : 'text-danger') }}"></i>
                            </div>
                            <div class="spec-detail">
                                <label>Battery Level</label>
                                <div class="progress battery-progress">
                                    <div class="progress-bar bg-{{ batteryColor }}" role="progressbar" 
                                         style="width: {{ batteryLevel }}%" 
                                         aria-valuenow="{{ batteryLevel }}" aria-valuemin="0" aria-valuemax="100">
                                        {{ batteryLevel }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-bolt text-warning"></i>
                            </div>
                            <div class="spec-detail">
                                <label>Range</label>
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold me-1">{{ rental.bicycle.rangeKm }}</span> km
                                </div>
                            </div>
                        </div>
                        
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-tag text-primary"></i>
                            </div>
                            <div class="spec-detail">
                                <label>Hourly Rate</label>
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold me-1">{{ isPremium ? '5.000' : '3.500' }}</span> TND/hour
                                </div>
                            </div>
                        </div>
                        
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-info-circle text-info"></i>
                            </div>
                            <div class="spec-detail">
                                <label>Status</label>
                                {% set bicycleStatus = rental.bicycle.status.value %}
                                <span class="status-pill {% if bicycleStatus == 'available' %}available{% elseif bicycleStatus == 'in_use' %}in-use{% elseif bicycleStatus == 'maintenance' %}maintenance{% else %}unavailable{% endif %}">
                                    <i class="fas fa-{{ bicycleStatus == 'available' ? 'check' : (bicycleStatus == 'in_use' ? 'bicycle' : (bicycleStatus == 'maintenance' ? 'tools' : 'times')) }} me-1"></i>
                                    {{ bicycleStatus|capitalize|replace({'_': ' '}) }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-map-marker-alt text-danger"></i>
                            </div>
                            <div class="spec-detail">
                                <label>Current Location</label>
                                {% if rental.bicycle.bicycleStation %}
                                    <div class="station-pill">
                                        <i class="fas fa-store me-1"></i>
                                        {{ rental.bicycle.bicycleStation.name }}
                                    </div>
                                {% else %}
                                    <span class="status-pill unavailable">
                                        <i class="fas fa-question-circle me-1"></i>
                                        Not at station
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="spec-item">
                            <div class="spec-icon">
                                <i class="fas fa-sync-alt text-secondary"></i>
                            </div>
                            <div class="spec-detail">
                                <label>Last Updated</label>
                                <small>{{ rental.bicycle.lastUpdated|date('M d, Y, h:i A') }}</small>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card-body p-4 text-center">
                    <div class="empty-bicycle-state">
                        <div class="empty-icon">
                            <i class="fas fa-bicycle"></i>
                        </div>
                        <h5 class="mt-3">No Bicycle Assigned</h5>
                        <p class="text-muted mb-0">This rental does not have a bicycle assigned to it.</p>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Weather Information (useful context) -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white p-4 border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-cloud-sun me-2"></i>Weather During Rental</h5>
                    <span class="badge bg-info text-white">Info</span>
                </div>
                <div class="card-body p-4">
                    <div class="weather-container">
                        <div class="weather-icon">
                            <i class="fas fa-sun"></i>
                        </div>
                        <div class="weather-details">
                            <div class="weather-temp">26°C</div>
                            <div class="weather-desc">Sunny, Light breeze</div>
                            <div class="weather-info">Perfect cycling conditions</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white p-4 border-0">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% if status == 'Active' %}
                            <a href="#" class="list-group-item list-group-item-action d-flex align-items-center p-3" data-bs-toggle="modal" data-bs-target="#completeRentalModal">
                                <div class="action-icon bg-success text-white">
                                    <i class="fas fa-flag-checkered"></i>
                                </div>
                                <div class="ms-3">
                                    <div class="fw-medium">Complete Rental</div>
                                    <small class="text-muted">Return bicycle and calculate final cost</small>
                                </div>
                                <i class="fas fa-chevron-right ms-auto"></i>
                            </a>
                        {% endif %}
                        {% if status != 'Completed' %}
                            <a href="#" class="list-group-item list-group-item-action d-flex align-items-center p-3 cancel-rental-btn" data-rental-id="{{ rental.idUserRental }}">
                                <div class="action-icon bg-danger text-white">
                                    <i class="fas fa-ban"></i>
                                </div>
                                <div class="ms-3">
                                    <div class="fw-medium">Cancel Rental</div>
                                    <small class="text-muted">Permanently cancel this rental</small>
                                </div>
                                <i class="fas fa-chevron-right ms-auto"></i>
                            </a>
                        {% endif %}
                        <a href="{{ path('admin_bicycle_rental_edit', {'id': rental.idUserRental}) }}" class="list-group-item list-group-item-action d-flex align-items-center p-3">
                            <div class="action-icon bg-primary text-white">
                                <i class="fas fa-pen"></i>
                            </div>
                            <div class="ms-3">
                                <div class="fw-medium">Edit Details</div>
                                <small class="text-muted">Modify rental information</small>
                            </div>
                            <i class="fas fa-chevron-right ms-auto"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center p-3" onclick="window.print();">
                            <div class="action-icon bg-info text-white">
                                <i class="fas fa-print"></i>
                            </div>
                            <div class="ms-3">
                                <div class="fw-medium">Print Details</div>
                                <small class="text-muted">Print a copy of this rental</small>
                            </div>
                            <i class="fas fa-chevron-right ms-auto"></i>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center p-3" data-bs-toggle="modal" data-bs-target="#contactUserModal">
                            <div class="action-icon bg-warning text-white">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="ms-3">
                                <div class="fw-medium">Contact User</div>
                                <small class="text-muted">Send a message to the customer</small>
                            </div>
                            <i class="fas fa-chevron-right ms-auto"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Forms for POST actions -->
<form id="activateRentalForm" method="POST" style="display: none;"></form>
<form id="cancelRentalForm" method="POST" style="display: none;"></form>

<!-- Improved Complete Rental Modal -->
<div class="modal fade" id="completeRentalModal" tabindex="-1" aria-labelledby="completeRentalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-gradient-success text-white">
                <h5 class="modal-title" id="completeRentalModalLabel">
                    <i class="fas fa-flag-checkered me-2"></i>Complete Rental
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ path('admin_bicycle_rental_edit', {'id': rental.idUserRental}) }}" method="POST" id="completeRentalForm">
                <div class="modal-body p-4">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label for="endStationId" class="form-label fw-medium">Return Station</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="fas fa-map-marker-alt text-danger"></i>
                                </span>
                                <select id="endStationId" name="endStationId" class="form-select" required>
                                    <option value="">-- Select Return Station --</option>
                                    
                                </select>
                            </div>
                            <small class="text-muted">The station where the bicycle was returned</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="distanceKm" class="form-label fw-medium">Distance Traveled (km)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="fas fa-route"></i>
                                </span>
                                <input type="number" id="distanceKm" name="distanceKm" class="form-control" step="0.1" min="0" value="0" required>
                                <span class="input-group-text bg-light">km</span>
                            </div>
                            <small class="text-muted">Total distance traveled during rental</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="batteryUsed" class="form-label fw-medium">Battery Used (%)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="fas fa-battery-half"></i>
                                </span>
                                <input type="number" id="batteryUsed" name="batteryUsed" class="form-control" step="0.1" min="0" max="100" value="0" required>
                                <span class="input-group-text bg-light">%</span>
                            </div>
                            <small class="text-muted">Percentage of battery used during rental</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="finalCost" class="form-label fw-medium">Final Cost (TND)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="fas fa-money-bill-wave"></i>
                                </span>
                                <input type="number" id="finalCost" name="finalCost" class="form-control" step="0.001" min="0" value="{{ rental.cost|number_format(3, '.', '') }}" required>
                                <span class="input-group-text bg-light">TND</span>
                            </div>
                            <small class="text-muted">Final amount to charge the customer</small>
                        </div>
                        
                        <div class="col-12">
                            <label for="completionNotes" class="form-label fw-medium">Notes</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="fas fa-clipboard"></i>
                                </span>
                                <textarea id="completionNotes" name="completionNotes" class="form-control" rows="2" placeholder="Any additional notes about this rental..."></textarea>
                            </div>
                        </div>
                        
                        <input type="hidden" name="completeRental" value="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check-circle me-2"></i>Complete Rental
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Contact User Modal -->
<div class="modal fade" id="contactUserModal" tabindex="-1" aria-labelledby="contactUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-gradient-warning">
                <h5 class="modal-title" id="contactUserModalLabel">
                    <i class="fas fa-envelope me-2"></i>Contact Customer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="#" method="POST" id="contactUserForm">
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label for="contactSubject" class="form-label fw-medium">Subject</label>
                        <input type="text" id="contactSubject" name="subject" class="form-control" 
                               value="Regarding your bicycle rental #B{{ '%05d'|format(rental.idUserRental) }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="contactMessage" class="form-label fw-medium">Message</label>
                        <textarea id="contactMessage" name="message" class="form-control" rows="5" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-paper-plane me-2"></i>Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Share Rental Modal -->
<div class="modal fade" id="shareRentalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-gradient-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-share-alt me-2"></i>Share Rental Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="qr-code-container mb-3">
                    <div class="qr-code">
                        <!-- Placeholder for QR code -->
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data={{ url('admin_bicycle_rental_show', {'id': rental.idUserRental})|url_encode }}" alt="QR Code">
                    </div>
                </div>
                
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="shareLink" value="{{ url('admin_bicycle_rental_show', {'id': rental.idUserRental}) }}" readonly>
                    <button class="btn btn-outline-primary" type="button" id="copyLink">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                
                <div class="share-buttons">
                    <button class="btn btn-primary" data-share="email">
                        <i class="fas fa-envelope"></i>
                    </button>
                    <button class="btn btn-success" data-share="whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </button>
                    <button class="btn btn-info" data-share="telegram">
                        <i class="fab fa-telegram"></i>
                    </button>
                    <button class="btn btn-secondary" data-share="more">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generic Confirmation Modal -->
<div class="modal fade" id="confirmActionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" id="confirmModalHeader">
                <h5 class="modal-title" id="confirmActionTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmActionBody">
                Are you sure you want to proceed with this action?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    /* Global Styles */
    :root {
        --color-primary: #0d6efd;
        --color-secondary: #6c757d;
        --color-success: #28a745;
        --color-warning: #ffc107;
        --color-danger: #dc3545;
        --color-info: #17a2b8;
        --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        --shadow-md: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
        --transition: all 0.3s ease;
        --border-radius: 0.5rem;
    }
    
    /* Timeline Styles */
    .rental-timeline {
        padding: 1.5rem 1rem;
        position: relative;
    }
    
    .timeline-progress {
        position: absolute;
        top: 50%;
        left: 2rem;
        height: 4px;
        background: var(--color-primary);
        transform: translateY(-50%);
        transition: width 0.5s ease;
        z-index: 1;
    }
    
    .timeline-step {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        z-index: 2;
    }
    
    .timeline-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        background: white;
        border: 4px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
        font-size: 1.2rem;
        color: #6c757d;
        transition: var(--transition);
    }
    
    .timeline-label {
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: #6c757d;
        transition: var(--transition);
    }
    
    .timeline-date {
        font-size: 0.875rem;
        color: #adb5bd;
    }
    
    .timeline-step.active .timeline-icon {
        border-color: var(--color-primary);
        color: var(--color-primary);
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2);
    }
    
    .timeline-step.active .timeline-label {
        color: var(--color-primary);
    }
    
    .timeline-step:nth-child(3).active .timeline-icon {
        border-color: var(--color-success);
        color: var(--color-success);
        box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.2);
    }
    
    .timeline-step:nth-child(3).active .timeline-label {
        color: var(--color-success);
    }
    
    /* Timer Display */
    .timer-display {
        display: flex;
        flex-direction: column;
    }
    
    .timer-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
    }
    
    .timer-unit {
        font-size: 1rem;
        margin-left: 0.25rem;
        margin-bottom: 0.25rem;
        align-self: flex-end;
    }
    
    /* Icon Box */
    .icon-box {
        width: 3rem;
        height: 3rem;
        min-width: 3rem;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    
    /* Detail Items */
    .detail-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    
    .detail-icon {
        width: 2.5rem;
        height: 2.5rem;
        min-width: 2.5rem;
        border-radius: 0.5rem;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: #495057;
        margin-right: 0.75rem;
    }
    
    .detail-content {
        flex: 1;
    }
    
    .detail-content label {
        display: block;
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    
    /* User Avatar */
    .user-avatar {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background: var(--color-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1rem;
    }
    
    /* Station Badge */
    .station-badge {
        display: inline-flex;
        align-items: center;
        background: #f8f9fa;
        border-radius: 2rem;
        padding: 0.35rem 0.75rem;
    }
    
    /* Metrics */
    .metric-box {
        background: #f8f9fa;
        border-radius: 0.75rem;
    }
    
    .metric-icon {
        font-size: 1.5rem;
        color: var(--color-primary);
    }
    
    .metric-value {
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1.2;
    }
    
    .metric-label {
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    /* Bicycle Display */
    .bicycle-image-container {
        position: relative;
        margin: 0 auto;
        width: 8rem;
        height: 8rem;
    }
    
    .bicycle-image {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: var(--color-primary);
        transition: var(--transition);
    }
    
    .bicycle-image.premium {
        color: var(--color-success);
        background: linear-gradient(135deg, #e9f7ef 0%, #d4edda 100%);
    }
    
    .bicycle-image.standard {
        color: var(--color-primary);
        background: linear-gradient(135deg, #e7f1ff 0%, #cfe2ff 100%);
    }
    
    .premium-badge {
        position: absolute;
        top: -0.5rem;
        right: -0.5rem;
        background: var(--color-warning);
        color: white;
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        box-shadow: var(--shadow-sm);
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.9; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    /* Specs Grid */
    .specs-grid {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }
    
    .spec-item {
        display: flex;
        align-items: center;
    }
    
    .spec-icon {
        width: 2.5rem;
        height: 2.5rem;
        min-width: 2.5rem;
        border-radius: 50%;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        margin-right: 0.75rem;
    }
    
    .spec-detail {
        flex: 1;
    }
    
    .spec-detail label {
        display: block;
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    
    /* Status Pills */
    .status-pill {
        display: inline-flex;
        align-items: center;
        border-radius: 2rem;
        padding: 0.35rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-pill.available {
        background-color: #d1e7dd;
        color: #0f5132;
    }
    
    .status-pill.in-use {
        background-color: #cfe2ff;
        color: #0a58ca;
    }
    
    .status-pill.maintenance {
        background-color: #fff3cd;
        color: #997404;
    }
    
    .status-pill.unavailable {
        background-color: #f8d7da;
        color: #b02a37;
    }
    
    .station-pill {
        display: inline-flex;
        align-items: center;
        background-color: #f8f9fa;
        border-radius: 2rem;
        padding: 0.35rem 0.75rem;
        font-size: 0.875rem;
    }
    
    /* Weather Display */
    .weather-container {
        display: flex;
        align-items: center;
    }
    
    .weather-icon {
        width: 4rem;
        height: 4rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: var(--color-warning);
        margin-right: 1rem;
    }
    
    .weather-details {
        flex: 1;
    }
    
    .weather-temp {
        font-size: 1.75rem;
        font-weight: 600;
        line-height: 1.2;
    }
    
    .weather-desc {
        font-size: 0.9rem;
        color: #495057;
    }
    
    .weather-info {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    /* Actions */
    .action-icon {
        width: 2.5rem;
        height: 2.5rem;
        min-width: 2.5rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }
    
    /* Empty States */
    .empty-bicycle-state {
        padding: 2rem 0;
    }
    
    .empty-icon {
        width: 5rem;
        height: 5rem;
        border-radius: 50%;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #adb5bd;
        margin: 0 auto;
    }
    
    /* Map */
    .rental-map {
        height: 300px;
        background: #f8f9fa url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23adb5bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>') center center no-repeat;
    }
    
    /* QR Code */
    .qr-code-container {
        display: flex;
        justify-content: center;
    }
    
    .qr-code {
        padding: 1rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: var(--shadow-sm);
    }
    
    .share-buttons {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        margin-top: 1.5rem;
    }
    
    .share-buttons .btn {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Gradient Backgrounds */
    .bg-gradient-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }
    
    .bg-gradient-warning {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    }
    
    .bg-gradient-info {
        background: linear-gradient(135deg, #17a2b8 0%, #0dcaf0 100%);
    }
    
    /* Battery Progress */
    .battery-progress {
        height: 0.75rem;
        border-radius: 1rem;
        overflow: hidden;
    }
    
    /* Active Timer Animation */
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .timeline-step .timeline-date {
            font-size: 0.75rem;
        }
        
        .timeline-icon {
            width: 2.5rem;
            height: 2.5rem;
            font-size: 1rem;
        }
        
        .timer-value {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Active Timer Functionality
    const activeTimer = document.getElementById('activeTimer');
    if (activeTimer) {
        function updateTimer() {
            const startTime = new Date(activeTimer.dataset.start);
            const now = new Date();
            const diffSeconds = Math.floor((now - startTime) / 1000);
            
            const hours = Math.floor(diffSeconds / 3600);
            const minutes = Math.floor((diffSeconds % 3600) / 60);
            
            const hoursDisplay = activeTimer.querySelector('.timer-value:first-child');
            const minutesDisplay = activeTimer.querySelector('.timer-value:last-child');
            
            hoursDisplay.textContent = hours;
            minutesDisplay.textContent = minutes;

            // Update final cost estimate in modal if open
            const finalCostInput = document.getElementById('finalCost');
            if (finalCostInput) {
                // Check if the bicycle is premium for rate calculation
                const hourlyRate = isPremium ? 5.0 : 3.5;
                const estimatedCost = (hourlyRate * (hours + (minutes / 60))).toFixed(3);
                finalCostInput.value = estimatedCost;
            }
        }
        
        updateTimer(); // Run once immediately
        setInterval(updateTimer, 60000); // Then update every minute
    }
    
    // Confirmation modal setup
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmActionModal'));
    let activeForm = null;
    
    // Leaflet map for completed rentals
    {% if rental.startStation and rental.endStation %}
    var mapContainer = document.getElementById('rentalRouteMap');
    if (mapContainer) {
        var startLat = {{ rental.startStation.latitude|default(0) }};
        var startLng = {{ rental.startStation.longitude|default(0) }};
        var endLat = {{ rental.endStation.latitude|default(0) }};
        var endLng = {{ rental.endStation.longitude|default(0) }};
        var map = L.map('rentalRouteMap').setView([(startLat + endLat)/2, (startLng + endLng)/2], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);
        var startMarker = L.marker([startLat, startLng]).addTo(map).bindPopup('Start: {{ rental.startStation.name|e('js') }}');
        var endMarker = L.marker([endLat, endLng]).addTo(map).bindPopup('End: {{ rental.endStation.name|e('js') }}');
        var routeLine = L.polyline([[startLat, startLng], [endLat, endLng]], {color: 'blue'}).addTo(map);
        map.fitBounds(routeLine.getBounds(), {padding: [30, 30]});
    }
    {% endif %}
});
</script>
{% endblock %}
