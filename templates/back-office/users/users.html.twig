{% extends 'back-office/base.html.twig' %}

{% block title %}User Management  - WamiaGo{% endblock %}

{% block head %}
    {{ parent() }}
    <!-- Force browser to reload all assets -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/user-management.css') }}?v={{ 'now'|date('YmdHis') }}">
    <link rel="stylesheet" href="{{ asset('css/pagination.css') }}?v={{ 'now'|date('YmdHis') }}">
    <link rel="stylesheet" href="{{ asset('css/pagination-enhancements.css') }}?v={{ 'now'|date('YmdHis') }}">
    <link rel="stylesheet" href="{{ asset('css/admin-user-management-enhancements.css') }}?v={{ 'now'|date('YmdHis') }}">
    <link rel="stylesheet" href="{{ asset('css/gender-badges.css') }}?v={{ 'now'|date('YmdHis') }}">
    <link rel="stylesheet" href="{{ asset('css/date-badge.css') }}?v={{ 'now'|date('YmdHis') }}">
    <link rel="stylesheet" href="{{ asset('css/user-cards-modern.css') }}?v={{ 'now'|date('YmdHis') }}">
    <link rel="stylesheet" href="{{ asset('css/table-sort.css') }}?v={{ 'now'|date('YmdHis') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css" integrity="sha256-tZHrRjVqNSRyWg2wbppGnT833E/Ys0DHWGwT04GiqQg=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css">
    
    <!-- Inline styles for immediate visibility and modern card styling -->
    <style>
        body { visibility: visible !important; }
        .loading-overlay { display: none !important; }
        
        /* Ban/Unban Button Styles */
        .btn-action.btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-action.btn-warning:hover {
            background-color: #e0a800;
        }
        
        .btn-action.btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-action.btn-success:hover {
            background-color: #218838;
        }
        
        /* Bulk Actions Toolbar Styles */
        .bulk-actions-toolbar {
            display: none;
            padding: 10px 15px;
            background: linear-gradient(to right, #f8f9fa, #eef1f5);
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border-left: 4px solid #3f6ad8;
        }
        
        .bulk-actions-toolbar.visible {
            display: flex;
            animation: slideDown 0.3s forwards;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .bulk-actions-counter {
            font-weight: 600;
            color: #3f6ad8;
            margin-right: 15px;
            display: flex;
            align-items: center;
        }
        
        .bulk-action-btn {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            padding: 5px 15px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            color: #495057;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .bulk-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }
        
        .bulk-action-btn i {
            margin-right: 5px;
        }
        
        .bulk-action-btn.ban-btn:hover {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        .bulk-action-btn.unban-btn:hover {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        .bulk-action-btn.export-btn:hover {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }
        
        .bulk-action-btn.delete-btn:hover {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        /* Checkbox styling */
        .select-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #d1d3e2;
            border-radius: 3px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: white;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .select-checkbox:checked {
            background-color: #4e73df;
            border-color: #4e73df;
        }
        
        .select-checkbox:checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            color: white;
            font-size: 11px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .select-checkbox:hover {
            border-color: #4e73df;
        }
        
        /* Modern User Card Styling - Enhanced */
        .user-card-modern {
            transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
            border-radius: 15px;
            overflow: hidden;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            background: linear-gradient(to bottom, #ffffff 0%, #fafafa 100%);
            position: relative;
        }
        
        .user-card-modern:before {
            content: "";
            position: absolute;
            z-index: -1;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 15px;
            box-shadow: 0 15px 25px rgba(0,0,0,0.15);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        
        .user-card-modern:hover {
            transform: translateY(-8px);
        }
        
        .user-card-modern:hover:before {
            opacity: 1;
        }
        
        .avatar-wrapper {
            position: relative;
            display: inline-block;
            margin-top: 5px;
            margin-bottom: 5px;
        }
        
        .user-avatar {
            width: 90px;
            height: 90px;
            object-fit: cover;
            border: 3px solid #fff;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .verification-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .verification-indicator:hover {
            transform: scale(1.2);
        }
        
        .verification-indicator.verified {
            background-color: #28a745;
        }
        
        .verification-indicator.not-verified {
            background-color: #ffc107;
        }
        
        .user-detail {
            display: flex;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px dashed rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        
        .user-detail:last-child {
            border-bottom: none;
        }
        
        .user-detail:hover {
            background-color: rgba(0,0,0,0.02);
            transform: translateX(5px);
        }
        
        .user-card-header {
            background: linear-gradient(135deg, #f5f7fa 0%, #eef1f5 100%);
            border-bottom: none;
        }
        
        .status-badge, .role-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }
        
        .status-badge:hover, .role-badge:hover {
            transform: scale(1.1);
        }
        
        .status-active {
            background: linear-gradient(135deg, #e3fcef 0%, #bdf7d6 100%);
            color: #0b5a2b;
        }
        
        .status-suspended {
            background: linear-gradient(135deg, #fff8e6 0%, #ffedbc 100%);
            color: #805803;
        }
        
        .status-banned {
            background: linear-gradient(135deg, #fee6e6 0%, #ffcaca 100%);
            color: #6a1a21;
        }
        
        .role-admin {
            background: linear-gradient(135deg, #e6f2ff 0%, #c0dfff 100%);
            color: #0c366a;
        }
        
        .role-client {
            background: linear-gradient(135deg, #e8f5ff 0%, #ccecff 100%);
            color: #0b4074;
        }
        
        .role-driver {
            background: linear-gradient(135deg, #f1e6ff 0%, #e2c5ff 100%);
            color: #3e1068;
        }
        
        .action-btn {
            border-radius: 20px;
            font-size: 0.8rem;
            padding: 6px 14px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .action-btn:after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background-color: rgba(255,255,255,0.2);
            transition: width 0.2s ease;
            z-index: -1;
        }
        
        .action-btn:hover:after {
            width: 100%;
        }
        
        .card-title {
            font-weight: 600;
            background: linear-gradient(90deg, #2c3e50, #4a6491);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }
        
        .card-footer {
            background: linear-gradient(135deg, #f9f9f9 0%, #f3f3f3 100%);
            border-top: none;
            position: relative;
        }
        
        .card-footer:before {
            content: "";
            position: absolute;
            top: 0;
            left: 5%;
            right: 5%;
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(0,0,0,0.05), transparent);
        }
        
        /* Improve grid layout */
        #users-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
            padding: 10px;
        }
        
        @media (max-width: 768px) {
            #users-card-container {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 15px;
            }
        }
        
        /* Quick action buttons */
        .quick-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .user-card-modern:hover .quick-actions {
            opacity: 1;
            transform: translateY(0);
        }
        
        .quick-action-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            color: #555;
            margin-left: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-action-btn:hover {
            transform: scale(1.15);
        }
        
        .quick-action-btn.edit-btn:hover {
            background: #28a745;
            color: white;
        }
        
        .quick-action-btn.delete-btn:hover {
            background: #dc3545;
            color: white;
        }
        
        /* User status dot */
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
            position: relative;
        }
        
        /* Table Sorting Styles */
        .sortable {
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        
        .sortable:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
        
        .sort-icon {
            margin-left: 5px;
            color: #ccc;
            transition: all 0.2s ease;
        }
        
        .sortable.asc .sort-icon {
            color: #3f6ad8;
            transform: rotate(180deg);
        }
        
        .sortable.desc .sort-icon {
            color: #3f6ad8;
        }
        
        .sortable.asc .sort-icon:before {
            content: "\f0d7"; /* fa-sort-down */
        }
        
        .sortable.desc .sort-icon:before {
            content: "\f0d7"; /* fa-sort-down */
        }
        
        .status-dot.active {
            background-color: #28a745;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
        }
        
        .status-dot.active:after {
            content: "";
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            border: 1px solid #28a745;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }
        
        /* Card animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-card-container {
            animation: fadeIn 0.5s ease forwards;
        }
        
        /* Scrollbar styling for card lists */
        #card-view::-webkit-scrollbar {
            width: 10px;
        }
        
        #card-view::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        #card-view::-webkit-scrollbar-thumb {
            background: #d7d7d7;
            border-radius: 10px;
        }
        
        #card-view::-webkit-scrollbar-thumb:hover {
            background: #c1c1c1;
        }
        
        /* Enhanced List View too */
        .users-table tbody tr {
            transition: all 0.2s ease;
        }
        
        .users-table tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05) !important;
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
    </style>
    
    <!-- Preload users data -->
    <script>
        // This will help users load instantly when page opens
        window.preloadedUsers = {{ users|json_encode|raw }};
        
        // Calculate stats
        window.preloadedStats = {
            total: {{ users|length }},
            active: {{ users|filter(user => user.account_status == 'ACTIVE')|length }},
            suspended: {{ users|filter(user => user.account_status == 'SUSPENDED')|length }},
            banned: {{ users|filter(user => user.account_status == 'BANNED')|length }}
        };
    </script>
{% endblock %}

{% block content_header %}
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2 align-items-center">
                <div class="col-sm-6">
                    <h1 class="m-0"><i class="fas fa-users mr-3 text-primary"></i>User Management</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right bg-transparent p-0 m-0">
                        <li class="breadcrumb-item"><a href="#" class="text-decoration-none"><i class="fas fa-home mr-1"></i>Home</a></li>
                        <li class="breadcrumb-item active">User Management</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="container-fluid user-management">
        <div class="row mb-4">
            <div class="col-md-12">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6">
                        <div class="card bg-gradient-primary text-white mb-4 stat-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-0 font-weight-bold">Total Users</h5>
                                        <h2 class="mt-2 mb-0" id="total-users-count">-</h2>
                                    </div>
                                    <div class="icon-circle bg-white text-primary">
                                        <i class="fas fa-users fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer d-flex align-items-center justify-content-between stat-card-footer">
                                <a class="small text-white stretched-link" href="#">View Details</a>
                                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card bg-gradient-success text-white mb-4 stat-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-0 font-weight-bold">Active Users</h5>
                                        <h2 class="mt-2 mb-0" id="active-users-count">-</h2>
                                    </div>
                                    <div class="icon-circle bg-white text-success">
                                        <i class="fas fa-user-check fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer d-flex align-items-center justify-content-between stat-card-footer">
                                <a class="small text-white stretched-link" href="#">View Details</a>
                                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card bg-gradient-warning text-white mb-4 stat-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-0 font-weight-bold">Suspended</h5>
                                        <h2 class="mt-2 mb-0" id="suspended-users-count">-</h2>
                                    </div>
                                    <div class="icon-circle bg-white text-warning">
                                        <i class="fas fa-user-clock fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer d-flex align-items-center justify-content-between stat-card-footer">
                                <a class="small text-white stretched-link" href="#">View Details</a>
                                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card bg-gradient-danger text-white mb-4 stat-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-0 font-weight-bold">Banned Users</h5>
                                        <h2 class="mt-2 mb-0" id="banned-users-count">-</h2>
                                    </div>
                                    <div class="icon-circle bg-white text-danger">
                                        <i class="fas fa-user-slash fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer d-flex align-items-center justify-content-between stat-card-footer">
                                <a class="small text-white stretched-link" href="#">View Details</a>
                                <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card main-card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="card-title"><i class="fas fa-users-cog mr-2"></i>User Management</h3>
                    <div class="d-flex">
                        <div class="view-toggle btn-group mr-3">
                            <button type="button" class="btn active" id="list-view-btn">
                                <i class="fas fa-list-ul"></i> <span>List</span>
                            </button>
                            <button type="button" class="btn" id="card-view-btn">
                                <i class="fas fa-th-large"></i> <span>Grid</span>
                            </button>
                        </div>
                        <button type="button" class="btn btn-rounded btn-add-user" id="add-user-btn">
                            <i class="fas fa-plus-circle mr-1"></i> Add User
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Enhanced Search and Filter Bar -->
                <div class="filter-controls">
                    <div class="row align-items-end">
                        <div class="col-lg-4 col-md-6 mb-3 mb-lg-0">
                            <label for="user-search" class="form-label"><i class="fas fa-search mr-1"></i> Search</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="user-search" placeholder="Name, email, phone...">
                            </div>
                        </div>
                        
                        <div class="col-lg-2 col-md-3 col-sm-6 mb-3 mb-lg-0">
                            <label for="filter-status" class="form-label"><i class="fas fa-user-shield mr-1"></i> Status</label>
                            <select class="form-control custom-select" id="filter-status">
                                <option value="">All Statuses</option>
                                {% for status in account_statuses %}
                                    <option value="{{ status.value }}">{{ status.value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-lg-2 col-md-3 col-sm-6 mb-3 mb-lg-0">
                            <label for="filter-role" class="form-label"><i class="fas fa-user-tag mr-1"></i> Role</label>
                            <select class="form-control custom-select" id="filter-role">
                                <option value="">All Roles</option>
                                {% for role in roles %}
                                    <option value="{{ role.value }}">{{ role.value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-lg-2 col-md-3 col-sm-6 mb-3 mb-lg-0">
                            <label for="filter-verified" class="form-label"><i class="fas fa-check-circle mr-1"></i> Verification</label>
                            <select class="form-control custom-select" id="filter-verified">
                                <option value="">All Users</option>
                                <option value="true">Verified</option>
                                <option value="false">Not Verified</option>
                            </select>
                        </div>
                        
                        <div class="col-lg-2 col-md-3 col-sm-6">
                            <div class="d-flex">
                                <button type="button" class="btn btn-primary filter-btn flex-fill mr-2" id="apply-filters-btn">
                                    <i class="fas fa-filter mr-1"></i> Apply
                                </button>
                                <button type="button" class="btn btn-outline-secondary filter-btn" id="reset-filters-btn">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- List View -->
                <div id="list-view" class="view-container">
                    <!-- Bulk Actions Toolbar -->
                    <div class="bulk-actions-toolbar" id="bulk-actions-toolbar">
                        <div class="bulk-actions-counter">
                            <i class="fas fa-check-square mr-2"></i> <span id="selected-count">0</span> users selected
                        </div>
                        <div class="bulk-actions">
                            <button type="button" class="bulk-action-btn ban-btn" id="bulk-ban-btn">
                                <i class="fas fa-ban"></i> Ban
                            </button>
                            <button type="button" class="bulk-action-btn unban-btn" id="bulk-unban-btn">
                                <i class="fas fa-unlock"></i> Unban
                            </button>
                            <button type="button" class="bulk-action-btn export-btn" id="bulk-export-btn">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                            <button type="button" class="bulk-action-btn delete-btn" id="bulk-delete-btn">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </div>
                        <div class="ml-auto">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-selection-btn">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover users-table" id="users-table">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" width="40">
                                        <input type="checkbox" class="select-checkbox" id="select-all-checkbox">
                                    </th>
                                    <th class="text-center sortable" width="50" data-sort="id"># <i class="fas fa-sort sort-icon"></i></th>
                                    <th width="220" class="sortable" data-sort="user">User <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="sortable" data-sort="contact">Contact Info <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="sortable" data-sort="dob">Date of Birth <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="sortable" data-sort="gender">Gender <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="sortable" data-sort="role">Role <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="sortable" data-sort="status">Status <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="sortable" data-sort="verification">Verification <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="text-center" width="150">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="align-middle">
                                <!-- User rows will be dynamically populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Enhanced Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div class="text-muted">
                            Showing <span id="showing-results">0</span> of <span id="total-results">0</span> users
                        </div>
                        <div class="pagination-container" data-results-id="showing-results" data-total-id="total-results">
                            <!-- Dynamic pagination will be generated here -->
                        </div>
                        <div class="d-flex align-items-center">
                            <label for="page-size" class="mb-0 mr-2 text-nowrap">Items per page:</label>
                            <select id="page-size" class="form-control form-control-sm" style="width: 70px;">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Card View -->
                <div id="card-view" class="view-container" style="display:none;">
                    <div id="users-card-container" class="user-cards-grid">
                        <!-- User cards will be dynamically populated here -->
                    </div>
                    <!-- Pagination for Card View -->
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div class="text-muted">
                            Showing <span id="showing-results-cards">0</span> of <span id="total-results-cards">0</span> users
                        </div>
                        <div class="pagination-container" data-results-id="showing-results-cards" data-total-id="total-results-cards">
                            <!-- Dynamic pagination will be generated here -->
                        </div>
                        <div class="d-flex align-items-center">
                            <label for="page-size-cards" class="mb-0 mr-2 text-nowrap">Items per page:</label>
                            <select id="page-size-cards" class="form-control form-control-sm" style="width: 70px;">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Include the modals with empty forms, they will be populated dynamically -->
    {% include 'back-office/users/edit.html.twig' with {'form': form_edit|default(null), 'modal_id': 'edit-user-modal'} %}
    {% include 'back-office/users/new.html.twig' with {'form': form_new|default(null), 'modal_id': 'new-user-modal'} %}
    {% include 'back-office/users/delete.html.twig' with {'form': form_delete|default(null), 'modal_id': 'delete-user-modal'} %}
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-spinner-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Processing...</div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <!-- SweetAlert2 for beautiful alerts and confirmations -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>
    <!-- Pass route URLs to the external JavaScript file -->
    <script>
        // Set route URLs as global variables for the JS file
        window.addUserRouteUrl = "{{ path('admin_user_new') }}";
        window.apiRouteUrl = "{{ path('admin_users_api') }}";
        // Use {id} placeholder instead of 'USER_ID' so JavaScript can replace it properly
        // Ensure the path generation includes the /admin prefix
        var userGetPath = "{{ path('admin_api_user_get', {'id': '__id__'}) }}";
        window.userGetUrl = userGetPath.replace('__id__', '{id}');
        
        // Make sure window.userGetUrl starts with /admin
        if (window.userGetUrl.startsWith('/users/')) {
            window.userGetUrl = '/admin' + window.userGetUrl;
            console.log('Fixed userGetUrl in template:', window.userGetUrl);
        }
        
        var userEditPath = "{{ path('admin_user_edit', {'id': '__id__'}) }}";
        window.userEditUrl = userEditPath.replace('__id__', '{id}');
        
        var userUpdatePath = "{{ path('admin_user_edit', {'id': '__id__'}) }}";
        window.userUpdateUrl = userUpdatePath.replace('__id__', '{id}'); // Assuming update uses the same route as edit form
        
        var userDeletePath = "{{ path('admin_user_delete', {'id': '__id__'}) }}";
        window.userDeleteUrl = userDeletePath.replace('__id__', '{id}');
        
        window.userCreateUrl = "{{ path('admin_user_new') }}";
        
        // Debug the generated URLs
        console.log('Generated API URLs in template:');
        console.log('- userGetUrl:', window.userGetUrl);
        console.log('- userEditUrl:', window.userEditUrl);
        console.log('- userUpdateUrl:', window.userUpdateUrl);
        console.log('- userDeleteUrl:', window.userDeleteUrl);
        console.log('- userDeleteApiUrl:', window.userDeleteApiUrl);
        console.log('- userCreateUrl:', window.userCreateUrl);
    </script>
    <!-- Include debug library for improved troubleshooting -->
    <script src="{{ asset('js/user/debug-api.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
    <!-- Include animation enhancements for cards -->
    <script src="{{ asset('js/user/card-animations.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
    <!-- Include modal handlers for better form validation and submission -->
    <script src="{{ asset('js/user/user-modal-handlers.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
    <!-- Include modal focus fix -->
    <script src="{{ asset('js/user/fix-modal-focus.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
    <!-- Include user ID attribute fixer -->
    <script src="{{ asset('js/user/fix-user-id-attributes.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
    <!-- Fix duplicate form IDs -->
    <script src="{{ asset('js/user/form-id-fix.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
    <!-- Fix duplicate element IDs in forms -->
    <script src="{{ asset('js/user/fix-form-duplicate-ids.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
    <!-- Validate and fix API URLs -->
    <script src="{{ asset('js/user/api-url-validator.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
    <!-- Include the enhanced user management script -->
    <script src="{{ asset('js/user/admin-user-management.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
    <!-- Include user status actions for quick ban/unban -->
    <script src="{{ asset('js/user/user-status-actions.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
    <!-- Include the new ban/unban toggle functionality -->
    <script src="{{ asset('js/user/user-ban-toggle.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
    <!-- URL placeholder diagnostic tool to detect issues with API URLs -->
    <script src="{{ asset('js/user/url-placeholder-diagnostic.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
    <!-- Include bulk actions functionality -->
    <script src="{{ asset('js/user/user-bulk-actions.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
    <!-- Include table sorting functionality -->
    <script src="{{ asset('js/user/table-sort.js') }}?v={{ 'now'|date('YmdHis') }}"></script>
{% endblock %}
