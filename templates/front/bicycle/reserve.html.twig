{% extends 'front/base.html.twig' %}

{% block title %}Reserve a Bicycle - WamiaGo{% endblock %}

{% block page_stylesheets %}
    <link href="{{ asset('css/front/Bicycle/bicycle-rental.css') }}?v={{ 'now'|date('YmdHi') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .bicycle-details {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .battery-indicator {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .battery-level {
            height: 100%;
            background-color: #28a745;
        }
        
        .reservation-form {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        
        .price-calculation {
            background-color: #e9f7ef;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .btn-reserve {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            padding: 10px 20px;
            font-weight: bold;
        }
        
        .weather-info {
            background-color: #f0f8ff;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            display: flex;
            align-items: center;
        }
        
        .weather-icon {
            font-size: 2rem;
            margin-right: 15px;
        }
        
        .rental-info-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        
        .rental-info-label {
            font-weight: bold;
            color: #555;
        }
        
        .estimated-return-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }
        
        .return-station-selector {
            margin-top: 15px;
        }

        .weather-loading {
            color: #6c757d;
            font-style: italic;
        }

        .weather-factor {
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .weather-factor-good {
            background-color: #d4edda;
            color: #155724;
        }

        .weather-factor-mild {
            background-color: #fff3cd;
            color: #856404;
        }

        .weather-factor-moderate {
            background-color: #ffe6cc;
            color: #8a5d19;
        }

        .weather-factor-challenging {
            background-color: #f8d7da;
            color: #721c24;
        }

        .weather-factor-difficult {
            background-color: #f5c2c7;
            color: #58151c;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container py-5">
        <div class="row mb-4">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ path('app_front_services_bicycle') }}">Bicycle Rentals</a></li>
                        <li class="breadcrumb-item"><a href="{{ path('app_front_services_bicycle_station', {'id': bicycle.bicycleStation.idStation}) }}">{{ bicycle.bicycleStation.name }}</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Reserve Bicycle</li>
                    </ol>
                </nav>
                <h1>Reserve a Bicycle</h1>
            </div>
        </div>

        {% for message in app.flashes('error') %}
            <div class="alert alert-danger">
                {{ message }}
            </div>
        {% endfor %}

        <div class="row">
            <div class="col-md-6">
                <div class="bicycle-details mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bicycle-icon me-3">
                            <i class="fas fa-bicycle fa-3x text-primary"></i>
                        </div>
                        <div>
                            <h3 class="mb-0">{{ bicycleType }}</h3>
                            <p class="text-muted mb-0">ID: #{{ bicycle.idBike }}</p>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-6">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-battery-three-quarters text-success me-2"></i>Battery</h5>
                                    <div class="battery-indicator">
                                        <div class="battery-level" style="width: {{ bicycle.batteryLevel }}%;"></div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <span class="fw-bold">{{ bicycle.batteryLevel }}%</span>
                                        <span class="badge bg-info">{{ bicycle.rangeKm }} km range</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-tag text-warning me-2"></i>Pricing</h5>
                                    <div class="pricing-info">
                                        <p class="mb-1"><span class="fw-bold">{{ hourlyRate|number_format(3) }} TND</span> / hour</p>
                                        <small class="text-muted">Weather conditions may affect pricing</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="station-info mt-4 p-3 border rounded">
                        <h5><i class="fas fa-map-marker-alt text-danger me-2"></i>Pick-up Location</h5>
                        <p class="mb-1"><strong>{{ bicycle.bicycleStation.name }}</strong></p>
                        <p class="mb-1">{{ bicycle.bicycleStation.location ? bicycle.bicycleStation.location.address : 'Address not available' }}</p>
                        <p class="mb-0 small">
                            <span class="badge bg-success me-2">{{ bicycle.bicycleStation.availableBikes }} bikes available</span>
                            <span class="badge bg-secondary">{{ bicycle.bicycleStation.availableDocks }} docks available</span>
                        </p>
                    </div>
                    
                    <div class="weather-info mt-4" id="weather-container">
                        <div class="weather-icon">
                            <i class="fas fa-spinner fa-pulse"></i>
                        </div>
                        <div>
                            <p class="mb-0"><strong>Current Weather:</strong> <span class="weather-loading">Loading...</span></p>
                            <p class="mb-0 weather-loading">Checking conditions...</p>
                            <small class="text-muted weather-loading">Weather affects pricing</small>
                        </div>
                    </div>
                    
                    <div class="rental-info-box mt-4">
                        <h5 class="mb-3"><i class="fas fa-info-circle text-info me-2"></i>How it works</h5>
                        <ol>
                            <li>Reserve the bicycle now</li>
                            <li>Go to "My Reservations" page to activate your reservation</li>
                            <li>Click the "Start Ride" button to begin using the bicycle</li>
                            <li>Use it for as long as you need</li>
                            <li>Return it to any available station</li>
                            <li>The final cost will be calculated when you return the bicycle</li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="reservation-form">
                    <h3>Reservation Details</h3>
                    
                    <form method="post" id="reservationForm" >
                        <div class="form-group mb-3">
                            <label>Current Date and Time:</label>
                            <input type="text" class="form-control" 
                                   value="{{ "now"|date('Y-m-d H:i') }}" readonly>
                            <small class="form-text text-muted">Your rental will be reserved now but will only start when you activate it from "My Reservations" page.</small>
                        </div>
                              {# Add this after the current date/time field in the reservation form #}
<div class="form-group mb-3">
    <label for="endStation">Destination Station:</label>
    <select class="form-control" id="endStation" name="endStation" required>
        <option value="">Select your destination</option>
        {% for station in stations %}
            <option value="{{ station.idStation }}">{{ station.name }}</option>
        {% endfor %}
    </select>
    <small class="form-text text-muted">Select where you plan to return the bicycle.</small>
</div>

<div class="mb-3 text-center">
    <button type="button" id="predictButton" class="btn btn-info">
        <i class="fas fa-magic me-2"></i>Get AI Prediction
    </button>
</div>

<div id="predictionLoading" class="text-center my-3 d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">AI is calculating your prediction...</p>
</div>

<div id="predictionResult" class="rental-info-box d-none">
    <h5 class="mb-3"><i class="fas fa-robot text-primary me-2"></i>AI-Powered Prediction</h5>
    
    <div class="row mb-3">
        <div class="col-4">
            <p><span class="rental-info-label">Distance:</span><br>
            <span id="predictionDistance">--</span> km</p>
        </div>
        <div class="col-4">
            <p><span class="rental-info-label">Duration:</span><br>
            <span id="predictionDuration">--</span> minutes</p>
        </div>
        <div class="col-4">
            <p><span class="rental-info-label">Estimated Cost:</span><br>
            <span id="predictionCost">--</span> TND</p>
        </div>
    </div>
    
    <div class="row mb-3 border-top pt-3">
        <div class="col-6">
            <p><span class="rental-info-label">Battery Usage:</span><br>
            <span id="predictionBattery">--</span></p>
        </div>
        <div class="col-6">
            <p><span class="rental-info-label">Weather Impact:</span><br>
            <span id="predictionWeather">--</span></p>
        </div>
    </div>

    <div id="rechargingAlert" class="alert alert-warning d-none mb-3">
        <i class="fas fa-charging-station me-2"></i>
        <strong>Battery Recharging Recommended:</strong>
        <span id="rechargingSuggestion">--</span>
    </div>

    <div class="enhanced-prediction border-top pt-3">
        <div class="row mb-2">
            <div class="col-12">
                <p class="rental-info-label"><i class="fas fa-route me-2 text-info"></i>Route Suggestion:</p>
                <p id="routeSuggestion" class="ps-4">--</p>
            </div>
        </div>
        
        <div class="accordion" id="predictionAccordion">

            <!-- Health & Safety -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#healthSafetyCollapse" aria-expanded="false" aria-controls="healthSafetyCollapse">
                        <i class="fas fa-heartbeat me-2 text-danger"></i> Health & Safety
                    </button>
                </h2>
                <div id="healthSafetyCollapse" class="accordion-collapse collapse" data-bs-parent="#predictionAccordion">
                    <div class="accordion-body">
                        <p><strong>Health Benefits:</strong> <span id="healthBenefits">--</span></p>
                        <p><strong>Safety Tips:</strong> <span id="safetyTips">--</span></p>
                        <p class="mt-2">
                            <strong>Difficulty Level:</strong> 
                            <span id="difficultyBadge" class="badge bg-success">--</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                        <div class="price-calculation">
                            <p><strong>Hourly Rate:</strong> {{ hourlyRate|number_format(3) }} TND</p>
                            <p><strong>Weather Conditions:</strong> <span id="weatherCondition">Loading...</span></p>
                            <p class="font-italic">The final price will be calculated when you return the bicycle.</p>
                            <hr>
                            <p class="h5"><strong>Estimated Deposit:</strong> <span id="totalCost">{{ hourlyRate|number_format(3) }}</span> TND</p>
                            <p class="small text-muted">This is a pre-authorization amount. You'll only be charged for the actual time used after activating the reservation.</p>
                            <input type="hidden" name="estimatedCost" id="estimatedCost" value="{{ hourlyRate }}">
                            <input type="hidden" name="duration" id="duration" value="1">
                        </div>
                        
                        <div class="form-group">
                            <p class="text-muted small">By reserving this bicycle, you agree to our <a href="#">Terms and Conditions</a>.</p>
                            <button type="submit" class="btn btn-reserve btn-lg w-100">Reserve Now</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# Station coordinates for weather API #}
    <input type="hidden" id="stationLatitude" value="{{ bicycle.bicycleStation.latitude|default(36.8065) }}">
    <input type="hidden" id="stationLongitude" value="{{ bicycle.bicycleStation.longitude|default(10.1815) }}">
{% endblock %}

{% block page_javascripts %}
    <script src="{{ asset('js/front/bicycle/weatherService.js') }}?v={{ 'now'|date('YmdHi') }}"></script>
    <script src="{{ asset('js/front/bicycle/predictionDisplay.js') }}?v={{ 'now'|date('YmdHi') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const totalCostSpan = document.getElementById('totalCost');
            const estimatedCostInput = document.getElementById('estimatedCost');
            const weatherConditionSpan = document.getElementById('weatherCondition');
            const weatherContainer = document.getElementById('weather-container');
            
            // Prediction elements
            const predictButton = document.getElementById('predictButton');
            const endStationSelect = document.getElementById('endStation');
            const predictionLoading = document.getElementById('predictionLoading');
            const predictionResult = document.getElementById('predictionResult');
            
            const hourlyRate = {{ hourlyRate }};
            let weatherFactor = 1.0; // Default factor
            
            // Initialize the weather service (it will fetch its API key from the backend)
            const weatherService = new WeatherService();
            
            // Get the station coordinates from the hidden inputs
            const latitude = parseFloat(document.getElementById('stationLatitude').value);
            const longitude = parseFloat(document.getElementById('stationLongitude').value);
            
            // Prediction button click handler
            predictButton.addEventListener('click', async function() {
                const endStationId = endStationSelect.value;
                
                if (!endStationId) {
                    alert('Please select a destination station first.');
                    return;
                }
                
                // Show loading indicator
                predictionLoading.classList.remove('d-none');
                predictionResult.classList.add('d-none');
                
                try {
                    // Make API request to get prediction
                    const response = await fetch('/services/bicycle/api-rental-predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            startStationId: {{ bicycle.bicycleStation.idStation }},
                            endStationId: endStationId,
                            bicycleId: {{ bicycle.idBike }}
                        })
                    });
                    
                    const predictionData = await response.json();
                    
                    if (predictionData.error) {
                        throw new Error(predictionData.error);
                    }
                    
                    // Use our helper class to update the UI
                    PredictionDisplay.updatePredictionUI(predictionData);
                    
                    // Update form costs with the predicted values if higher than default
                    const predictedCost = parseFloat(predictionData.estimatedCost);
                    if (predictedCost > parseFloat(estimatedCostInput.value)) {
                        totalCostSpan.textContent = predictedCost.toFixed(3);
                        estimatedCostInput.value = predictedCost;
                    }
                    
                    // Show results
                    predictionResult.classList.remove('d-none');
                    
                } catch (error) {
                    console.error('Error getting prediction:', error);
                    alert('Unable to get prediction at this time. Please try again later.');
                } finally {
                    // Hide loading indicator
                    predictionLoading.classList.add('d-none');
                }
            });
            
            // Fetch weather data for the bicycle station location
            async function loadWeatherData() {
                try {
                    // Initialize the weather service first (this fetches the API key)
                    await weatherService.init();
                    
                    const weatherData = await weatherService.getWeatherData(latitude, longitude);
                    
                    // Update the weather factor for price calculation
                    weatherFactor = weatherData.weatherFactor;
                    
                    // Update the weather UI
                    updateWeatherUI(weatherData);
                    
                    // Recalculate price with new weather factor
                    updatePriceCalculation();
                } catch (error) {
                    console.error('Failed to load weather data:', error);
                    // Use default values in case of error
                    weatherFactor = 1.0;
                    updateWeatherUIError();
                    updatePriceCalculation();
                }
            }
            
            function updateWeatherUI(weatherData) {
                // Get the appropriate CSS class based on weather factor
                let weatherFactorClass = 'weather-factor-good';
                if (weatherFactor > 1.3) weatherFactorClass = 'weather-factor-difficult';
                else if (weatherFactor > 1.2) weatherFactorClass = 'weather-factor-challenging';
                else if (weatherFactor > 1.1) weatherFactorClass = 'weather-factor-moderate';
                else if (weatherFactor > 1.0) weatherFactorClass = 'weather-factor-mild';
                
                // Create weather HTML
                weatherContainer.innerHTML = `
                    <div class="weather-icon">
                        <i class="fas ${weatherData.icon}"></i>
                    </div>
                    <div>
                        <p class="mb-0"><strong>Current Weather:</strong> ${weatherData.description}</p>
                        <p class="mb-0">${weatherData.temperature}°C, Wind: ${weatherData.windSpeed} m/s</p>
                        <p class="mt-1 mb-0">
                            <span class="weather-factor ${weatherFactorClass}">
                                ${weatherService.getWeatherDescription(weatherFactor)}
                            </span>
                        </p>
                    </div>
                `;
            }
            
            function updateWeatherUIError() {
                weatherContainer.innerHTML = `
                    <div class="weather-icon">
                        <i class="fas fa-sun"></i>
                    </div>
                    <div>
                        <p class="mb-0"><strong>Current Weather:</strong> Not available</p>
                        <p class="mb-0">Using default conditions</p>
                        <small class="text-muted">No weather surcharge applied</small>
                    </div>
                `;
            }
            
            function updatePriceCalculation() {
                // We use a multiplier to ensure there's enough deposit for longer rentals
                const depositMultiplier = 1.5; // 50% buffer for unexpected extended usage
                const estimatedDeposit = (hourlyRate * weatherFactor * depositMultiplier).toFixed(3);
                
                // Update display
                totalCostSpan.textContent = estimatedDeposit;
                estimatedCostInput.value = estimatedDeposit;
                
                // Update weather condition text
                weatherConditionSpan.textContent = weatherService.getWeatherDescription(weatherFactor);
            }
            
            // Load initial weather data
            loadWeatherData();
        });
    </script>
{% endblock %}